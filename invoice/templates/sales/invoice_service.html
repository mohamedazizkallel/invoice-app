<!--  ============================
      FULL CORRECTED INVOICES PAGE
      ============================ -->

{% extends 'partials/base.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block css %}
<style>
  .page-header {
    background: white;
    padding: 1.5rem;
    border-radius: 0.5rem;
    margin-bottom: 1.5rem;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
  }
  .filter-section {
    background: white;
    border-radius: 0.5rem;
    padding: 1rem;
    margin-bottom: 1.5rem;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
  }
  .table-container {
    background: white;
    border-radius: 0.5rem;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    padding: 1.5rem;
  }
  .status-badge {
    padding: 0.35rem 0.75rem;
    border-radius: 0.25rem;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
  }
  .status-current { background-color: #d1ecf1; color: #0c5460; }
  .status-overdue { background-color: #f8d7da; color: #721c24; }
  .status-paid { background-color: #d4edda; color: #155724; }
  .status-draft { background-color: #e2e3e5; color: #383d41; }
  .invoice-row { cursor: pointer; transition: background-color 0.15s ease-in-out; }
  .invoice-row:hover { background-color: #f8f9fa; }
  .empty-state { text-align: center; padding: 3rem 1rem; }
  .empty-state img { max-width: 100%; height: auto; margin-top: 1.5rem; }
  .empty-state h3 { color: #6c757d; font-weight: 400; margin-bottom: 1rem; }
  .import-export-card { background: #f8f9fa; border: 2px dashed #dee2e6; border-radius: 0.5rem; padding: 1.5rem; text-align: center; margin-bottom: 1.5rem; }
  .modal-content { animation: fadeSlide 0.25s ease-out; border: none; }
  @keyframes fadeSlide {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .modal-body { overflow-y: auto !important; }
  .modal-dialog-scrollable .modal-body { max-height: 70vh; }

  /* Service INPUTS */
  .create-service-select {
    font-size: 0.875rem;
  }
  #servicesContainer .card {
    border-left: 3px solid #0d6efd;
  }
</style>
{% endblock %}

{% block main %}

<!-- ======================================= -->
<!-- MAIN PAGE CONTENT (unchanged)           -->
<!-- ======================================= -->

<main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">

  <!-- PAGE HEADER -->
  <div class="page-header d-flex justify-content-between align-items-center flex-wrap">
    <h1 class="h2 mb-0">Invoices</h1>
    <div class="btn-toolbar">
      <div class="btn-group me-2">
      </div>
      <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createInvoiceModal">
        <i class="bi bi-plus-circle me-1"></i> Create Invoice
      </button>
    </div>
  </div>

    <!-- Filter Section -->
  <div class="filter-section">
    <form method="get" class="row g-3 align-items-end">
      <div class="col-md-3">
        <label for="filterSearch" class="form-label">Search</label>
        <input type="text" class="form-control" id="filterSearch" name="search" placeholder="Search invoices..." value="{{ request.GET.search }}">
      </div>
      <div class="col-md-3">
        <label for="filterStatus" class="form-label">Status</label>
        <select class="form-select" id="filterStatus" name="status">
          <option value="">All Statuses</option>
          <option value="DRAFT" {% if request.GET.status == "DRAFT" %}selected{% endif %}>Draft</option>
          <option value="CURRENT" {% if request.GET.status == "CURRENT" %}selected{% endif %}>Current</option>
          <option value="OVERDUE" {% if request.GET.status == "OVERDUE" %}selected{% endif %}>Overdue</option>
          <option value="PAID" {% if request.GET.status == "PAID" %}selected{% endif %}>Paid</option>
        </select>
      </div>
      <div class="col-md-3">
        <label for="filterClient" class="form-label">Client</label>
        <select class="form-select" id="filterClient" name="client">
          <option value="">All Clients</option>
          {% for client in clients %}
          <option value="{{ client.id }}" {% if request.GET.client == client.id|stringformat:"s" %}selected{% endif %}>
            {{ client.clientname }}
          </option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-3">
        <button type="submit" class="btn btn-primary w-100">
          <i class="bi bi-funnel me-1"></i> Apply Filter
        </button>
      </div>
    </form>
  </div>

  {% if invoices|length > 0 %}
  <!-- Invoices Table -->
  <div class="table-container">
    <div class="table-responsive">
      <table class="table table-hover mb-0">
        <thead class="table-light">
          <tr>
            <th scope="col">Invoice #</th>
            <th scope="col">Title</th>
            <th scope="col">Client</th>
            <th scope="col">Date Created</th>
            <th scope="col">Status</th>
            <th scope="col" class="text-end">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for invoice in invoices %}
          <tr class="invoice-row">
            <td class="align-middle">
              <a href="{% url 'invoice_detail' invoice.id %}" class="text-decoration-none fw-bold">
                INV-{{ invoice.uniqueId|default:invoice.id }}
              </a>
            </td>
            <td class="align-middle">{{ invoice.title }}</td>
            <td class="align-middle">{{ invoice.client.clientname|default:"No Client" }}</td>
            <td class="align-middle">{{ invoice.date_created|date:"M d, Y"|default:"N/A" }}</td>
            <td class="align-middle">
              <span class="status-badge status-{{ invoice.status|lower }}">{{ invoice.status }}</span>
            </td>
            <td class="align-middle text-end">
              <div class="btn-group btn-group-sm">
                <a href="{% url 'invoice_detail' invoice.id %}" class="btn btn-outline-primary" title="View">
                  <i class="bi bi-eye"></i>
                </a>
                <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#editInvoiceModal{{ invoice.id }}" title="Edit">
                  <i class="bi bi-pencil"></i>
                </button>
                <button type="button" class="btn btn-outline-danger" title="Delete" data-bs-toggle="modal" data-bs-target="#deleteInvoiceModal{{ invoice.id }}">
                  <i class="bi bi-trash"></i>
                </button>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Pagination -->
    {% if is_paginated %}
    <nav aria-label="Invoice pagination" class="mt-4">
      <ul class="pagination justify-content-center mb-0">
        {% if page_obj.has_previous %}
        <li class="page-item">
          <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}{% if request.GET.client %}&client={{ request.GET.client }}{% endif %}">Previous</a>
        </li>
        {% else %}
        <li class="page-item disabled">
          <span class="page-link">Previous</span>
        </li>
        {% endif %}

        {% for num in page_obj.paginator.page_range %}
        {% if page_obj.number == num %}
        <li class="page-item active"><span class="page-link">{{ num }}</span></li>
        {% else %}
        <li class="page-item"><a class="page-link" href="?page={{ num }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}{% if request.GET.client %}&client={{ request.GET.client }}{% endif %}">{{ num }}</a></li>
        {% endif %}
        {% endfor %}

        {% if page_obj.has_next %}
        <li class="page-item">
          <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}{% if request.GET.client %}&client={{ request.GET.client }}{% endif %}">Next</a>
        </li>
        {% else %}
        <li class="page-item disabled">
          <span class="page-link">Next</span>
        </li>
        {% endif %}
      </ul>
    </nav>
    {% endif %}
  </div>
  {% else %}
  <!-- Empty State -->
  <div class="table-container">
    <div class="empty-state">
      <div class="row justify-content-center">
        <div class="col-lg-6">
          <h3>No Invoices Found</h3>
          <p class="text-muted">Get started by creating your first invoice or adjust your filters to see more results.</p>
          <img src="{% static 'assets/img/empty.svg' %}" alt="No invoices illustration">
          <div class="mt-4">
            <button type="button" class="btn btn-primary btn-lg" data-bs-toggle="modal" data-bs-target="#createInvoiceModal">
              <i class="bi bi-plus-circle me-2"></i> Create Your First Invoice
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
  {% endif %}

    <div class="modal fade" id="createInvoiceModal" tabindex="-1">
      <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
          <div class="modal-content shadow-lg rounded-4">
          <form action="{% url 'invoice_create' %}" method="post" id="createInvoiceForm">
              {% csrf_token %}
              <input type="hidden" name="services_data" id="services_data">

              <div class="modal-header border-0 pb-0">
              <h5 class="modal-title fw-semibold">
                <i class="bi bi-file-earmark-plus me-2 text-primary"></i> Create New Invoice
              </h5>
                <button class="btn-close" data-bs-dismiss="modal"></button>
              </div>

              <div class="modal-body pt-2">
              {% if form.errors %}
              <div class="alert alert-danger rounded-3" role="alert">
                  <strong><i class="bi bi-exclamation-triangle me-2"></i> Please correct the following errors:</strong>
                  <ul class="mt-2 mb-0">
                  {% for field, errors in form.errors.items %}
                      {% for error in errors %}
                      <li>{{ field }}: {{ error }}</li>
                      {% endfor %}
                  {% endfor %}
                  </ul>
              </div>
              {% endif %}

              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label fw-semibold">Invoice Title</label>
                  <input type="text" class="form-control" name="title" required>
                  </div>

                  <div class="col-md-6">
                  <label class="form-label fw-semibold">Client</label>
                  <select class="form-select" name="client" required>
                      <option value="">Select Client</option>
                      {% for client in clients %}
                      <option value="{{ client.id }}">{{ client.clientname }}</option>
                      {% endfor %}
                  </select>
                  </div>

                  <div class="col-md-3">
                  <label class="form-label fw-semibold">Status</label>
                  <select class="form-select" name="status">
                    <option value="CURRENT">Current</option>
                    <option value="OVERDUE">Overdue</option>
                    <option value="PAID">Paid</option>
                  </select>
                  </div>

                  <div class="col-md-3">
                    <label class="form-label fw-semibold">TVA (%)</label>
                    <input type="number" step="0.01" class="form-control" name="tva" value="{{ settings.tva|default:19.00 }}" placeholder="{{ settings.tva|default:19.00 }}">
                    <small class="text-muted">Default: {{ settings.tva|default:19.00 }}%</small>
                  </div>

                  <div class="col-md-3">
                    <label class="form-label fw-semibold">Timbre Fiscal (D)</label>
                    <input type="number" step="0.001" class="form-control" name="timbre_fiscal" value="{{ settings.dt|default:1.000 }}" placeholder="{{ settings.dt|default:1.000 }}">
                    <small class="text-muted">Default from Settings: {{ settings.dt|default:1.000 }}D</small>
                  </div>

                  <div class="col-md-3">
                    <label class="form-label fw-semibold">Discount (%)</label>
                    <input type="number" step="0.01" class="form-control" name="discount" value="0.00">
                  </div>

                  <div class="col-12">
                    <label class="form-label fw-semibold">Notes</label>
                    <textarea class="form-control" name="notes" rows="2"></textarea>
                  </div>

                  <div class="col-12">
                    <hr class="my-3">
                    <div class="d-flex justify-content-between mb-3">
                      <h6 class="fw-semibold"><i class="bi bi-briefcase me-2"></i> Add Services</h6>
                      <button type="button" class="btn btn-sm btn-outline-primary" id="addServiceRow">
                        <i class="bi bi-plus-circle me-1"></i> Add Service
                      </button>
                    </div>

                    <!-- This container was missing -->
                    <div id="servicesContainer"></div>
                  </div>
                </div>
              </div>

              <div class="modal-footer border-0">
              <button class="btn btn-light px-4" data-bs-dismiss="modal" type="button">Cancel</button>
              <button class="btn btn-primary px-4" type="submit">
                  <i class="bi bi-check-circle me-1"></i> Create Invoice
              </button>
              </div>
          </form>
          </div>
      </div>
    </div>

  <!-- Edit and Delete Modals for Each Invoice -->
  {% for invoice in invoices %}
  
  <!-- Edit Invoice Modal -->
  <div class="modal fade" id="editInvoiceModal{{ invoice.id }}" tabindex="-1" aria-labelledby="editInvoiceModalLabel{{ invoice.id }}" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content shadow-lg rounded-4">
        <form action="{% url 'invoice_edit' invoice.id %}" method="post" id="editInvoiceForm{{ invoice.id }}">
          {% csrf_token %}
          <input type="hidden" name="services_data" id="edit_services_data_{{ invoice.id }}">

          <!-- Modal Header -->
          <div class="modal-header border-0 pb-0">
            <h5 class="modal-title fw-semibold" id="editInvoiceModalLabel{{ invoice.id }}">
              <i class="bi bi-pencil me-2 text-secondary"></i> Edit Invoice
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>

          <!-- Modal Body -->
          <div class="modal-body pt-2">
            {% if form.errors %}
            <div class="alert alert-danger rounded-3" role="alert">
              <strong><i class="bi bi-exclamation-triangle me-2"></i> Please correct the following errors:</strong>
              <ul class="mt-2 mb-0">
                {% for field, errors in form.errors.items %}
                  {% for error in errors %}
                  <li>{{ field }}: {{ error }}</li>
                  {% endfor %}
                {% endfor %}
              </ul>
            </div>
            {% endif %}

            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label fw-semibold">Invoice Title</label>
                <input type="text" class="form-control" name="title" value="{{ invoice.title }}" required>
              </div>

              <div class="col-md-6">
                <label class="form-label fw-semibold">Client</label>
                <select class="form-select" name="client" required>
                  {% for client in clients %}
                  <option value="{{ client.id }}" {% if invoice.client.id == client.id %}selected{% endif %}>
                    {{ client.clientname }}
                  </option>
                  {% endfor %}
                </select>
              </div>

              <div class="col-md-3">
                <label class="form-label fw-semibold">Status</label>
                <select class="form-select" name="status">
                  <option value="CURRENT" {% if invoice.status == "CURRENT" %}selected{% endif %}>Current</option>
                  <option value="OVERDUE" {% if invoice.status == "OVERDUE" %}selected{% endif %}>Overdue</option>
                  <option value="PAID" {% if invoice.status == "PAID" %}selected{% endif %}>Paid</option>
                </select>
              </div>

              <div class="col-md-3">
                <label class="form-label fw-semibold">TVA (%)</label>
                <input type="number" step="0.01" class="form-control" name="tva" value="{{ invoice.tva|default:19.00 }}">
                <small class="text-muted">Default: {{ settings.tva|default:19.00 }}%</small>
              </div>

              <div class="col-md-3">
                <label class="form-label fw-semibold">Timbre Fiscal (D)</label>
                <input type="number" step="0.001" class="form-control" name="timbre_fiscal" value="{{ invoice.timbre_fiscal|default:settings.dt|default:1.000 }}">
                <small class="text-muted">Default: {{ settings.dt|default:1.000 }}D</small>
              </div>

              <div class="col-md-3">
                <label class="form-label fw-semibold">Discount (%)</label>
                <input type="number" step="0.01" class="form-control" name="discount" value="{{ invoice.discount|default:0.00 }}">
              </div>

              <div class="col-12">
                <label class="form-label fw-semibold">Notes</label>
                <textarea class="form-control" name="notes" rows="2">{{ invoice.notes }}</textarea>
              </div>

              <!-- Service Section -->
              <!-- Service Section -->
              <!-- Service Section -->
              <div class="col-12">
                <hr class="my-3">
                <div class="d-flex justify-content-between align-items-center mb-3">
                  <h6 class="mb-0 fw-semibold">
                    <i class="bi bi-box-seam me-2"></i> Add/Edit Service
                  </h6>
                  <button type="button" class="btn btn-sm btn-outline-primary" id="addEditServiceRow_{{ invoice.id }}">
                    <i class="bi bi-plus-circle me-1"></i> Add Service
                  </button>
                </div>

                <div id="editServicesContainer_{{ invoice.id }}">
                  <!-- Preloaded service Rows -->
                  {% for service in invoice.service.all %}
                  <div class="card mb-2">
                    <div class="card-body p-3">
                      <div class="row g-2 align-items-end">
                        <div class="col-md-6">
                          <label class="form-label small mb-1">Services</label>
                          <select class="form-select form-select-sm service-select" data-row="{{ forloop.counter0 }}">
                            {% for p in services %}
                              <option value="{{ p.id }}" {% if p.id == service.id %}selected{% endif %}>
                              </option>
                            {% endfor %}
                          </select>
                        </div>
                        <div class="col-md-2">
                          <label class="form-label small mb-1">Total</label>
                          <input type="text" class="form-control form-control-sm line-total" data-row="{{ forloop.counter0 }}" readonly>
                        </div>
                        <div class="col-md-1">
                          <button type="button" class="btn btn-sm btn-outline-danger w-100 remove-service" data-row="{{ forloop.counter0 }}">
                            <i class="bi bi-trash"></i>
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                  {% endfor %}
                </div>

                <div class="alert alert-info mt-3" role="alert">
                  <small>
                    <i class="bi bi-info-circle me-1"></i>
                    Click "Add Service" to select service
                  </small>
                </div>
              </div>

            </div>
          </div>

          <!-- Modal Footer -->
          <div class="modal-footer border-0">
            <button type="button" class="btn btn-light px-4" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary px-4">
              <i class="bi bi-check-circle me-1"></i> Save Changes
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Delete Invoice Modal -->
  <div class="modal fade" id="deleteInvoiceModal{{ invoice.id }}" tabindex="-1" aria-labelledby="deleteInvoiceModalLabel{{ invoice.id }}" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content shadow-lg rounded-4">
        <form action="{% url 'invoice_delete' invoice.id %}" method="post">
          {% csrf_token %}

          <!-- Modal Header -->
          <div class="modal-header border-0 pb-0">
            <h5 class="modal-title fw-semibold text-danger" id="deleteInvoiceModalLabel{{ invoice.id }}">
              <i class="bi bi-trash me-2"></i> Delete Invoice
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>

          <!-- Modal Body -->
          <div class="modal-body pt-2">
            <div class="alert alert-danger rounded-3" role="alert">
              <i class="bi bi-exclamation-triangle me-2"></i>
              <strong>Warning!</strong> This action cannot be undone.
            </div>
            <p class="mb-0">Are you sure you want to delete the invoice <strong>"{{ invoice.title }}"</strong>?</p>
          </div>

          <!-- Modal Footer -->
          <div class="modal-footer border-0">
            <button type="button" class="btn btn-light px-4" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-danger px-4">
              <i class="bi bi-trash me-1"></i> Delete Invoice
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  {% endfor %}
</main>

<!-- ============================================================== -->
<!--   COMPLETELY CORRECTED JAVASCRIPT  (CREATE MODAL ONLY FIXED)   -->
<!-- ============================================================== -->

<script>

  let serviceRowCounter = 0;

  const availableServices = [
    {% for service in services %}
    {
      id: {{ service.id }},
      title: "{{ service.title|escapejs }}",
      price: {{ service.price|default:0 }},
      currency: "{{ service.currency|default:'TND' }}"
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
  ];

  document.getElementById("addServiceRow")?.addEventListener("click", () => {
    const container = document.getElementById("servicesContainer");

    const row = document.createElement("div");
    row.className = "card mb-2";
    row.innerHTML = `
      <div class="card-body p-3">
        <div class="row g-2 align-items-end">

          <div class="col-md-6">
            <label class="form-label small mb-1">Service</label>
            <select name="service_id[]" class="form-select form-select-sm create-service-select" data-row="${serviceRowCounter}">
              <option value="">Select Service</option>
              ${availableServices.map(s => `
                <option value="${s.id}" data-price="${s.price}" data-currency="${s.currency}">
                  ${s.title} - ${s.currency} ${s.price}
                </option>
              `).join("")}
            </select>
          </div>

          <div class="col-md-3">
            <label class="form-label small mb-1">Total</label>
            <input type="text" class="form-control form-control-sm line-total" readonly>
          </div>

          <div class="col-md-1">
            <button type="button" class="btn btn-sm btn-outline-danger w-100 remove-service">
              <i class="bi bi-trash"></i>
            </button>
          </div>

        </div>
      </div>
    `;

    container.appendChild(row);

    const select = row.querySelector(".create-service-select");
    const total = row.querySelector(".line-total");

    function updateTotals() {
      const opt = select.options[select.selectedIndex];
      const price = parseFloat(opt.dataset.price || 0);
      const currency = opt.dataset.currency || "";

      if (!select.value) {
        total.value = "";
        return;
      }

      total.value = `${currency} ${price.toFixed(3)}`;
    }

    select.addEventListener("change", updateTotals);

    row.querySelector(".remove-service").onclick = () => row.remove();

    serviceRowCounter++;
  });

  document.getElementById("createInvoiceForm")?.addEventListener("submit", e => {
    const selects = document.querySelectorAll("#createInvoiceModal .create-service-select");

    const list = [];

    for (let i = 0; i < selects.length; i++) {
      const opt = selects[i].options[selects[i].selectedIndex];

      if (!selects[i].value) {
        e.preventDefault();
        alert("Please select a service.");
        return;
      }

      list.push({
        service_id: selects[i].value,
 
      });
    }

    if (list.length === 0) {
      e.preventDefault();
      alert("Add at least one service.");
      return;
    }

    document.getElementById("services_data").value = JSON.stringify(list);
  });
  // Auto-add one service row on modal open
  document.getElementById('createInvoiceModal')?.addEventListener('shown.bs.modal', function() {
    if (serviceRowCounter === 0) {
      document.getElementById('addServiceRow')?.click();
    }
  });

  {% for invoice in invoices %}
  (function() {
    const invoiceId = {{ invoice.id }};
    let editServiceCounter = {{ invoice.service.all|length }};

    // Add Service Row Handler
    document.getElementById(`addEditServiceRow_${invoiceId}`)?.addEventListener("click", () => {
      const container = document.getElementById(`editServicesContainer_${invoiceId}`);

      const row = document.createElement("div");
      row.className = "card mb-2";
      row.innerHTML = `
        <div class="card-body p-3">
          <div class="row g-2 align-items-end">
            <div class="col-md-6">
              <label class="form-label small mb-1">Service</label>
              <select name="service_id[]" class="form-select form-select-sm edit-service-select" data-row="${editServiceCounter}">
                <option value="">Select Service</option>
                ${availableServices.map(s => `
                  <option value="${s.id}" data-price="${s.price}" data-currency="${s.currency}">
                    ${s.title} - ${s.currency} ${s.price}
                  </option>
                `).join("")}
              </select>
            </div>

            <div class="col-md-3">
              <label class="form-label small mb-1">Total</label>
              <input type="text" class="form-control form-control-sm line-total" readonly>
            </div>

            <div class="col-md-1">
              <button type="button" class="btn btn-sm btn-outline-danger w-100 remove-service">
                <i class="bi bi-trash"></i>
              </button>
            </div>
          </div>
        </div>
      `;

      container.appendChild(row);

      const select = row.querySelector(".edit-service-select");
      const total = row.querySelector(".line-total");

      function updateTotals() {
        const opt = select.options[select.selectedIndex];
        const price = parseFloat(opt.dataset.price || 0);
        const currency = opt.dataset.currency || "";

        if (!select.value) {
          total.value = "";
          return;
        }

        total.value = `${currency} ${price.toFixed(3)}`;
      }

      select.addEventListener("change", updateTotals);
      row.querySelector(".remove-service").onclick = () => row.remove();

      editServiceCounter++;
    });


    // Initialize existing service rows with change listeners
    document.querySelectorAll(`#editServicesContainer_${invoiceId} .card`).forEach(card => {
      const select = card.querySelector(".service-select");
      const total = card.querySelector(".line-total");

      if (select && total) {
        // Change name attribute to array format
        select.name = "service_id[]";

        function updateTotals() {
          const opt = select.options[select.selectedIndex];
          const price = parseFloat(opt.dataset.price || 0);
          const currency = opt.dataset.currency || "";
          total.value = `${currency} ${price.toFixed(3)}`;
        }

        select.addEventListener("change", updateTotals);
        card.querySelector(".remove-service")?.addEventListener("click", () => card.remove());

        updateTotals(); // Initial calculation
      }
    });
  })();
  {% endfor %}
</script>
<style>
  .service-select {
    font-size: 0.875rem;
  }
  
  .line-total {
    background-color: #f8f9fa;
    font-weight: 600;
  }


  #servicesContainer .card {
    border-left: 3px solid #0d6efd;
  }
</style>
{% endblock %}