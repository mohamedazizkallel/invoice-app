{% extends 'partials/base.html' %}
{% load static %}

{% block css %}
<style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');

    body {
        font-family: 'Inter', sans-serif !important;
        background: #f5f6f7;
    }

    .wrapper-invoice {
        display: flex;
        justify-content: center;
        padding: 40px 15px;
    }

    .invoice {
        background: #fff;
        max-width: 900px;
        width: 100%;
        box-shadow: 0px 10px 40px rgba(0,0,0,0.08);
        border-radius: 12px;
        padding: 40px;
        animation: fadeIn 0.4s ease;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .invoice-information p {
        margin: 0;
        line-height: 1.6;
        font-size: 15px;
    }

    .invoice-logo-brand img {
        width: 130px;
        margin-top: 10px;
        filter: drop-shadow(0px 1px 2px rgba(0,0,0,0.2));
    }

    .invoice-head {
        display: flex;
        justify-content: space-between;
        margin-top: 35px;
        gap: 20px;
    }

    .invoice-body { 
        margin-top: 40px; 
    }

    .table {
        width: 100%;
        border-collapse: collapse;
    }

    .table thead {
        background: #fafafa;
        border-bottom: 2px solid #eee;
    }

    .table th, .table td {
        padding: 14px 10px;
        font-size: 15px;
        border-bottom: 1px solid #eee;
    }

    .invoice-total-amount {
        margin-top: 25px;
        text-align: right;
        font-size: 22px;
        font-weight: 700;
        color: #2f2f2f;
    }

    .invoice-footer {
        margin-top: 40px;
        text-align: center;
        font-size: 15px;
        color: #888;
        border-top: 1px solid #eee;
        padding-top: 25px;
    }

    .btn-custom {
        padding: 10px 22px;
        border-radius: 8px;
        font-weight: 600;
    }

    .btn-edit {
        background: #4c6ef5;
        color: white;
        border: none;
    }

    .btn-edit:hover {
        background: #3b5bdb;
        color: white;
    }

    .btn-back {
        border: 1px solid #adb5bd;
        color: #495057;
        background: white;
    }

    .btn-back:hover {
        background: #f8f9fa;
    }

    .btn-print {
        background: #12b886;
        color: white;
        border: none;
    }

    .btn-print:hover {
        background: #0ca678;
        color: white;
    }

    .modal-content {
        animation: modalFade 0.25s ease-out;
        border: none;
    }

    @keyframes modalFade {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @media (max-width: 700px) {
        .invoice-head {
            flex-direction: column;
            text-align: left;
        }
        
        .head.client-data {
            text-align: left !important;
        }
    }

    /* ---------------- PRINT ONLY INVOICE ---------------- */
    @media print {
        body {
            background: white !important;
        }

        /* hide UI elements */
        .btn,
        .btn-custom,
        .navbar,
        .sidebar,
        .modal,
        .modal-backdrop,
        .invoice-footer,
        .mt-4,
        nav {
            display: none !important;
        }

        /* print only invoice */
        .wrapper-invoice {
            padding: 0 !important;
        }

        .invoice {
            box-shadow: none !important;
            border: none !important;
            margin: 0 !important;
            padding: 20px !important;
        }

        @page {
            margin: 15mm;
        }
    }
    .modal-body {
    overflow-y: auto !important;
    }
    .modal-dialog-scrollable .modal-body {
        max-height: 70vh; /* limit height so it becomes scrollable */
        }
</style>
{% endblock %}

{% block main %}
<main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
    <!-- ========= INVOICE CONTENT ========= -->
    <section class="wrapper-invoice">
        <div class="invoice" id="invoiceArea">

            <div class="invoice-information">
                <p><b>Invoice #</b> : {{ invoice.uniqueId }}</p>
                <p><b>Created Date</b> : {{ invoice.date_created|date:"M d, Y" }}</p>
                <p><b>Status</b> : <span class="badge {% if invoice.status == 'PAID' %}bg-success{% elif invoice.status == 'OVERDUE' %}bg-danger{% elif invoice.status == 'CURRENT' %}bg-info{% else %}bg-secondary{% endif %}">{{ invoice.status }}</span></p>
            </div>

            <div class="invoice-logo-brand">
                {% if p_settings and p_settings.clientLogo %}
                    <img src="{{ p_settings.clientLogo.url }}" alt="Company Logo">
                {% else %}
                    <img src="{% static 'assets/img/logo.png' %}" alt="Company Logo">
                {% endif %}
            </div>

            <div class="invoice-head">
                <div class="head client-info">
                    <p><strong>From:</strong></p>
                    <p><strong>{{ p_settings.clientname|default:"Your Company Name" }}</strong></p>
                    <p>{{ p_settings.adress|default:"Your Address" }}</p>
                    {% if p_settings.mf %}<p>MF: {{ p_settings.mf }}</p>{% endif %}
                </div>

                <div class="head client-data" style="text-align:right;">
                    <p><strong>Bill To:</strong></p>
                    <p><strong>{{ invoice.client.clientname }}</strong></p>
                    <p>{{ invoice.client.adress }}</p>
                    {% if invoice.client.emailAddress %}<p>{{ invoice.client.emailAddress }}</p>{% endif %}
                    {% if invoice.client.mf %}<p>MF: {{ invoice.client.mf }}</p>{% endif %}
                </div>
            </div>

            <div class="invoice-body">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Item Description</th>
                            <th style="text-align:center;">Qty</th>
                            <th style="text-align:right;">Unit Price</th>
                            <th style="text-align:right;">Amount</th>
                        </tr>
                    </thead>
                    <tbody>
                    {% if products_with_totals %}
                        {% for item in products_with_totals %}
                        <tr>
                            <td>
                                {{ item.product.title }}
                                <small class="text-muted d-block">Current Stock: {{ item.current_stock }}</small>
                            </td>
                            <td style="text-align:center;">{{ item.invoice_quantity|floatformat:2 }}</td>
                            <td style="text-align:right;">{{ item.product.currency|default:"TND" }} {{ item.unit_price|floatformat:3 }}</td>
                            <td style="text-align:right;">{{ item.product.currency|default:"TND" }} {{ item.line_total|floatformat:3 }}</td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="4" style="text-align:center; color: #888;">No products assigned to this invoice</td>
                        </tr>
                    {% endif %}
                    </tbody>
                </table>

                {% if products_with_totals %}
                <div style="margin-top: 25px; text-align: right;">
                    <table style="width: 300px; margin-left: auto; border-collapse: collapse;">
                        <tr>
                            <td style="padding: 8px; border-top: 1px solid #eee;"><strong>Subtotal HT:</strong></td>
                            <td style="padding: 8px; text-align: right; border-top: 1px solid #eee;">{{ invoiceCurrency }} {{ subtotal|floatformat:3 }}</td>
                        </tr>
                        {% if invoice.discount > 0 %}
                        <tr>
                            <td style="padding: 8px;"><strong>Discount ({{ invoice.discount }}%):</strong></td>
                            <td style="padding: 8px; text-align: right; color: #dc3545;">-{{ invoiceCurrency }} {{ discount_amount|floatformat:3 }}</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px;"><strong>Subtotal after discount:</strong></td>
                            <td style="padding: 8px; text-align: right;">{{ invoiceCurrency }} {{ subtotal_after_discount|floatformat:3 }}</td>
                        </tr>
                        {% endif %}
                        <tr>
                            <td style="padding: 8px;"><strong>TVA ({{ invoice.tva }}%):</strong></td>
                            <td style="padding: 8px; text-align: right;">{{ invoiceCurrency }} {{ tva_amount|floatformat:3 }}</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px;"><strong>Timbre Fiscal (D):</strong></td>
                            <td style="padding: 8px; text-align: right;">{{ invoiceCurrency }} {{ invoice.timbre_fiscal|floatformat:3 }}</td>
                        </tr>
                        <tr style="border-top: 2px solid #2f2f2f;">
                            <td style="padding: 12px;"><strong style="font-size: 18px;">Total TTC:</strong></td>
                            <td style="padding: 12px; text-align: right; font-size: 18px; font-weight: 700;">{{ invoiceCurrency }} {{ total|floatformat:3 }}</td>
                        </tr>
                    </table>
                </div>
                
                {% if not invoice.inventory_adjusted %}
                <div class="alert alert-warning mt-3" role="alert">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    <strong>Warning:</strong> Inventory has not been deducted for this invoice.
                </div>
                {% endif %}
                {% endif %}
            </div>

            {% if invoice.notes %}
            <div style="margin-top:25px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                <strong>Notes:</strong>
                <p style="margin: 5px 0 0 0;">{{ invoice.notes }}</p>
            </div>
            {% endif %}

            <div class="invoice-footer">
                <p>Thank you for your business!</p>
            </div>

            <!-- Buttons -->
            <div class="mt-4 d-flex gap-2 justify-content-between flex-wrap">
                <a href="{% url 'invoices_list' %}" class="btn btn-back btn-custom">
                    <i class="bi bi-arrow-left me-1"></i> Back to Invoices
                </a>

                <div class="d-flex gap-2">
                    <button class="btn btn-print btn-custom" onclick="window.print()">
                        <i class="bi bi-printer me-1"></i> Print Invoice
                    </button>

                    <button class="btn btn-edit btn-custom" data-bs-toggle="modal" data-bs-target="#editInvoiceModal{{ invoice.id }}">
                        <i class="bi bi-pencil me-1"></i> Edit Invoice
                    </button>
                </div>
            </div>

        </div>
    </section>

    <!-- ========= ENHANCED EDIT MODAL ========= -->
    <div class="modal fade" id="editInvoiceModal{{ invoice.id }}" tabindex="-1" aria-labelledby="editInvoiceModalLabel{{ invoice.id }}" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content shadow-lg rounded-4">
                <form action="{% url 'invoice_edit' invoice.id %}" method="post" id="editInvoiceForm{{ invoice.id }}">
                    {% csrf_token %}
                    <input type="hidden" name="products_data" id="edit_products_data_{{ invoice.id }}">

                    <!-- Modal Header -->
                    <div class="modal-header border-0 pb-0">
                        <h5 class="modal-title fw-semibold" id="editInvoiceModalLabel{{ invoice.id }}">
                            <i class="bi bi-pencil me-2 text-secondary"></i> Edit Invoice
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>

                    <!-- Modal Body -->
                    <div class="modal-body pt-2">
                        {% if form.errors %}
                        <div class="alert alert-danger rounded-3" role="alert">
                            <strong><i class="bi bi-exclamation-triangle me-2"></i> Please correct the following errors:</strong>
                            <ul class="mt-2 mb-0">
                                {% for field, errors in form.errors.items %}
                                    {% for error in errors %}
                                    <li>{{ field }}: {{ error }}</li>
                                    {% endfor %}
                                {% endfor %}
                            </ul>
                        </div>
                        {% endif %}

                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">Invoice Title</label>
                                <input type="text" class="form-control" name="title" value="{{ invoice.title }}" required>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label fw-semibold">Client</label>
                                <select class="form-select" name="client" required>
                                    {% for client in clients %}
                                    <option value="{{ client.id }}" {% if invoice.client.id == client.id %}selected{% endif %}>
                                        {{ client.clientname }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>

                            <div class="col-md-3">
                                <label class="form-label fw-semibold">Status</label>
                                <select class="form-select" name="status">
                                    <option value="CURRENT" {% if invoice.status == "CURRENT" %}selected{% endif %}>Current</option>
                                    <option value="OVERDUE" {% if invoice.status == "OVERDUE" %}selected{% endif %}>Overdue</option>
                                    <option value="PAID" {% if invoice.status == "PAID" %}selected{% endif %}>Paid</option>
                                </select>
                            </div>

                            <div class="col-md-3">
                                <label class="form-label fw-semibold">TVA (%)</label>
                                <input type="number" step="0.01" class="form-control" name="tva" value="{{ invoice.tva|default:19.00 }}">
                            </div>

                            <div class="col-md-3">
                                <label class="form-label fw-semibold">Timbre Fiscal (D)</label>
                                <input type="number" step="0.001" class="form-control" name="timbre_fiscal" value="{{ invoice.timbre_fiscal|default:1.000 }}">
                            </div>

                            <div class="col-md-3">
                                <label class="form-label fw-semibold">Discount (%)</label>
                                <input type="number" step="0.01" class="form-control" name="discount" value="{{ invoice.discount|default:0.00 }}">
                            </div>

                            <div class="col-12">
                                <label class="form-label fw-semibold">Notes</label>
                                <textarea class="form-control" name="notes" rows="2">{{ invoice.notes }}</textarea>
                            </div>

                            <!-- Products Section -->
                            <div class="col-12">
                                <hr class="my-3">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h6 class="mb-0 fw-semibold">
                                        <i class="bi bi-box-seam me-2"></i> Add/Edit Products
                                    </h6>
                                    <button type="button" class="btn btn-sm btn-outline-primary" id="addEditProductRow_{{ invoice.id }}">
                                        <i class="bi bi-plus-circle me-1"></i> Add Product
                                    </button>
                                </div>

                                <div id="editProductsContainer_{{ invoice.id }}">
                                    <!-- Preloaded Product Rows -->
                                    {% for product in invoice.product.all %}
                                    <div class="card mb-2 product-row" data-row="{{ forloop.counter0 }}">
                                        <div class="card-body p-3">
                                            <div class="row g-2 align-items-end">
                                                <div class="col-md-6">
                                                    <label class="form-label small mb-1">Product</label>
                                                    <select class="form-select form-select-sm product-select" data-row="{{ forloop.counter0 }}">
                                                        {% for p in all_products %}
                                                        <option value="{{ p.id }}" 
                                                                data-price="{{ p.price }}" 
                                                                data-currency="{{ p.currency|default:'TND' }}" 
                                                                data-stock="{{ p.quantity }}"
                                                                {% if p.id == product.id %}selected{% endif %}>
                                                            {{ p.title }} (Stock: {{ p.quantity }}) - {{ p.currency|default:"TND" }} {{ p.price }}
                                                        </option>
                                                        {% endfor %}
                                                    </select>
                                                </div>
                                                <div class="col-md-3">
                                                    <label class="form-label small mb-1">Quantity</label>
                                                    <input type="number" class="form-control form-control-sm quantity-input" data-row="{{ forloop.counter0 }}" min="1" step="1" value="1">
                                                </div>
                                                <div class="col-md-2">
                                                    <label class="form-label small mb-1">Total</label>
                                                    <input type="text" class="form-control form-control-sm line-total" data-row="{{ forloop.counter0 }}" readonly>
                                                </div>
                                                <div class="col-md-1">
                                                    <button type="button" class="btn btn-sm btn-outline-danger w-100 remove-product" data-row="{{ forloop.counter0 }}">
                                                        <i class="bi bi-trash"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>

                                <div class="alert alert-info mt-3" role="alert">
                                    <small>
                                        <i class="bi bi-info-circle me-1"></i>
                                        Click "Add Product" to select products and specify quantities. The system will check available inventory.
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Modal Footer -->
                    <div class="modal-footer border-0">
                        <button type="button" class="btn btn-light px-4" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary px-4">
                            <i class="bi bi-check-circle me-1"></i> Save Changes
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</main>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const invoiceId = '{{ invoice.id }}';
    const container = document.getElementById(`editProductsContainer_${invoiceId}`);
    const addButton = document.getElementById(`addEditProductRow_${invoiceId}`);
    const form = document.getElementById(`editInvoiceForm${invoiceId}`);
    const productsDataInput = document.getElementById(`edit_products_data_${invoiceId}`);
    
    let rowCounter = {{ invoice.product.all|length }};

    // Products data from backend
    const availableProducts = [
        {% for p in all_products %}
        {
            id: '{{ p.id }}',
            title: '{{ p.title|escapejs }}',
            price: parseFloat('{{ p.price }}'),
            currency: '{{ p.currency|default:"TND" }}',
            stock: parseFloat('{{ p.quantity }}')
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];

    // Calculate line total
    function calculateLineTotal(row) {
        const select = container.querySelector(`.product-select[data-row="${row}"]`);
        const qtyInput = container.querySelector(`.quantity-input[data-row="${row}"]`);
        const totalInput = container.querySelector(`.line-total[data-row="${row}"]`);
        
        if (select && qtyInput && totalInput) {
            const selectedOption = select.options[select.selectedIndex];
            const price = parseFloat(selectedOption.dataset.price) || 0;
            const currency = selectedOption.dataset.currency || 'TND';
            const quantity = parseFloat(qtyInput.value) || 0;
            const stock = parseFloat(selectedOption.dataset.stock) || 0;
            
            const total = price * quantity;
            totalInput.value = `${currency} ${total.toFixed(3)}`;
            
            // Validate stock
            if (quantity > stock) {
                qtyInput.classList.add('is-invalid');
                if (!qtyInput.nextElementSibling || !qtyInput.nextElementSibling.classList.contains('invalid-feedback')) {
                    const feedback = document.createElement('div');
                    feedback.className = 'invalid-feedback';
                    feedback.textContent = `Only ${stock} available in stock`;
                    qtyInput.parentNode.appendChild(feedback);
                }
            } else {
                qtyInput.classList.remove('is-invalid');
                const feedback = qtyInput.parentNode.querySelector('.invalid-feedback');
                if (feedback) feedback.remove();
            }
        }
    }

    // Add new product row
    addButton.addEventListener('click', function() {
        const newRow = document.createElement('div');
        newRow.className = 'card mb-2 product-row';
        newRow.dataset.row = rowCounter;
        
        newRow.innerHTML = `
            <div class="card-body p-3">
                <div class="row g-2 align-items-end">
                    <div class="col-md-6">
                        <label class="form-label small mb-1">Product</label>
                        <select class="form-select form-select-sm product-select" data-row="${rowCounter}">
                            <option value="">Select a product...</option>
                            {% for p in all_products %}
                            <option value="{{ p.id }}" 
                                    data-price="{{ p.price }}" 
                                    data-currency="{{ p.currency|default:'TND' }}" 
                                    data-stock="{{ p.quantity }}">
                                {{ p.title }} (Stock: {{ p.quantity }}) - {{ p.currency|default:"TND" }} {{ p.price }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label small mb-1">Quantity</label>
                        <input type="number" class="form-control form-control-sm quantity-input" data-row="${rowCounter}" min="1" step="1" value="1">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label small mb-1">Total</label>
                        <input type="text" class="form-control form-control-sm line-total" data-row="${rowCounter}" readonly>
                    </div>
                    <div class="col-md-1">
                        <button type="button" class="btn btn-sm btn-outline-danger w-100 remove-product" data-row="${rowCounter}">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        container.appendChild(newRow);
        
        // Attach event listeners to new row
        const select = newRow.querySelector('.product-select');
        const qtyInput = newRow.querySelector('.quantity-input');
        const removeBtn = newRow.querySelector('.remove-product');
        
        select.addEventListener('change', () => calculateLineTotal(rowCounter));
        qtyInput.addEventListener('input', () => calculateLineTotal(rowCounter));
        removeBtn.addEventListener('click', () => newRow.remove());
        
        rowCounter++;
    });

    // Attach listeners to existing rows
    container.querySelectorAll('.product-row').forEach(row => {
        const rowNum = row.dataset.row;
        const select = row.querySelector('.product-select');
        const qtyInput = row.querySelector('.quantity-input');
        const removeBtn = row.querySelector('.remove-product');
        
        if (select) {
            select.addEventListener('change', () => calculateLineTotal(rowNum));
            calculateLineTotal(rowNum); // Initial calculation
        }
        if (qtyInput) {
            qtyInput.addEventListener('input', () => calculateLineTotal(rowNum));
        }
        if (removeBtn) {
            removeBtn.addEventListener('click', () => row.remove());
        }
    });

    // Form submission - collect products data
    form.addEventListener('submit', function(e) {
        const productsData = [];
        const rows = container.querySelectorAll('.product-row');
        
        rows.forEach(row => {
            const select = row.querySelector('.product-select');
            const qtyInput = row.querySelector('.quantity-input');
            
            if (select && qtyInput && select.value) {
                const productId = select.value;
                const quantity = parseFloat(qtyInput.value) || 0;
                
                if (quantity > 0) {
                    productsData.push({
                        product_id: productId,
                        quantity: quantity
                    });
                }
            }
        });
        
        // Store as JSON in hidden input
        productsDataInput.value = JSON.stringify(productsData);
        
        // Validate at least one product
        if (productsData.length === 0) {
            e.preventDefault();
            alert('Please add at least one product to the invoice.');
            return false;
        }
    });
});
</script>
{% endblock %}