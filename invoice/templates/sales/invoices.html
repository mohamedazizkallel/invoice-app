{% extends 'partials/base.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block css %}
<style>
  .page-header {
    background: white;
    padding: 1.5rem;
    border-radius: 0.5rem;
    margin-bottom: 1.5rem;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
  }
  
  .filter-section {
    background: white;
    border-radius: 0.5rem;
    padding: 1rem;
    margin-bottom: 1.5rem;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
  }
  
  .table-container {
    background: white;
    border-radius: 0.5rem;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    padding: 1.5rem;
  }
  
  .status-badge {
    padding: 0.35rem 0.75rem;
    border-radius: 0.25rem;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
  }
  
  .status-current {
    background-color: #d1ecf1;
    color: #0c5460;
  }
  
  .status-overdue {
    background-color: #f8d7da;
    color: #721c24;
  }
  
  .status-paid {
    background-color: #d4edda;
    color: #155724;
  }
  
  .status-draft {
    background-color: #e2e3e5;
    color: #383d41;
  }
  
  .invoice-row {
    cursor: pointer;
    transition: background-color 0.15s ease-in-out;
  }
  
  .invoice-row:hover {
    background-color: #f8f9fa;
  }
  
  .empty-state {
    text-align: center;
    padding: 3rem 1rem;
  }
  
  .empty-state img {
    max-width: 100%;
    height: auto;
    margin-top: 1.5rem;
  }
  
  .empty-state h3 {
    color: #6c757d;
    font-weight: 400;
    margin-bottom: 1rem;
  }
</style>
{% endblock %}

{% block main %}
<main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
  <!-- Page Header -->
  <div class="page-header d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center">
    <h1 class="h2 mb-0">Invoices</h1>
    <div class="btn-toolbar">
      <div class="btn-group me-2">
        <button type="button" class="btn btn-outline-secondary">
          <i class="bi bi-printer me-1"></i> Print
        </button>
        <button type="button" class="btn btn-outline-secondary">
          <i class="bi bi-download me-1"></i> Export
        </button>
      </div>
      <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createInvoiceModal">
        <i class="bi bi-plus-circle me-1"></i> Create Invoice
      </button>
    </div>
  </div>

  <!-- Filter Section -->
  <div class="filter-section">
    <form method="get" class="row g-3 align-items-end">
      <div class="col-md-3">
        <label for="filterStatus" class="form-label">Status</label>
        <select class="form-select" id="filterStatus" name="status">
          <option value="">All Statuses</option>
          <option value="draft">Draft</option>
          <option value="current">Current</option>
          <option value="overdue">Overdue</option>
          <option value="paid">Paid</option>
        </select>
      </div>
      <div class="col-md-3">
        <label for="filterClient" class="form-label">Client</label>
        <select class="form-select" id="filterClient" name="client">
          <option value="">All Clients</option>
          {% for client in clients %}
          <option value="{{ client.id }}">{{ client.clientName }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-3">
        <label for="filterDate" class="form-label">Date Range</label>
        <input type="date" class="form-control" id="filterDate" name="date_from">
      </div>
      <div class="col-md-3">
        <button type="submit" class="btn btn-primary w-100">
          <i class="bi bi-funnel me-1"></i> Apply Filters
        </button>
      </div>
    </form>
  </div>

  {% if invoices|length > 0 %}
  <!-- Invoices Table -->
  <div class="table-container">
    <div class="table-responsive">
      <table class="table table-hover mb-0">
        <thead class="table-light">
          <tr>
            <th scope="col">Invoice #</th>
            <th scope="col">Client</th>
            <th scope="col">Issue Date</th>
            <th scope="col">Due Date</th>
            <th scope="col" class="text-end">Amount</th>
            <th scope="col">Status</th>
            <th scope="col" class="text-end">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for invoice in invoices %}
          <tr class="invoice-row">
            <td class="align-middle">
              <a href="{% url 'invoice_detail' invoice.id %}" class="text-decoration-none">
                INV-{{ invoice.id|stringformat:"04d" }}
              </a>
            </td>
            <td class="align-middle">{{ invoice.client.clientName }}</td>
            <td class="align-middle">{{ invoice.issue_date|date:"M d, Y" }}</td>
            <td class="align-middle">{{ invoice.due_date|date:"M d, Y" }}</td>
            <td class="align-middle text-end">R{{ invoice.total_amount|floatformat:2 }}</td>
            <td class="align-middle">
              <span class="status-badge status-{{ invoice.status|lower }}">{{ invoice.status }}</span>
            </td>
            <td class="align-middle text-end">
              <div class="btn-group btn-group-sm">
                <a href="{% url 'invoice_detail' invoice.id %}" class="btn btn-outline-primary" title="View">
                  <i class="bi bi-eye"></i>
                </a>
                <a href="{% url 'invoice_edit' invoice.id %}" class="btn btn-outline-secondary" title="Edit">
                  <i class="bi bi-pencil"></i>
                </a>
                <button type="button" class="btn btn-outline-danger" title="Delete" data-bs-toggle="modal" data-bs-target="#deleteModal{{ invoice.id }}">
                  <i class="bi bi-trash"></i>
                </button>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Pagination -->
    {% if is_paginated %}
    <nav aria-label="Invoice pagination" class="mt-4">
      <ul class="pagination justify-content-center mb-0">
        {% if page_obj.has_previous %}
        <li class="page-item">
          <a class="page-link" href="?page={{ page_obj.previous_page_number }}">Previous</a>
        </li>
        {% else %}
        <li class="page-item disabled">
          <span class="page-link">Previous</span>
        </li>
        {% endif %}

        {% for num in page_obj.paginator.page_range %}
        {% if page_obj.number == num %}
        <li class="page-item active"><span class="page-link">{{ num }}</span></li>
        {% else %}
        <li class="page-item"><a class="page-link" href="?page={{ num }}">{{ num }}</a></li>
        {% endif %}
        {% endfor %}

        {% if page_obj.has_next %}
        <li class="page-item">
          <a class="page-link" href="?page={{ page_obj.next_page_number }}">Next</a>
        </li>
        {% else %}
        <li class="page-item disabled">
          <span class="page-link">Next</span>
        </li>
        {% endif %}
      </ul>
    </nav>
    {% endif %}
  </div>
  {% else %}
  <!-- Empty State -->
  <div class="table-container">
    <div class="empty-state">
      <div class="row justify-content-center">
        <div class="col-lg-6">
          <h3>No Invoices Found</h3>
          <p class="text-muted">Get started by creating your first invoice or adjust your filters to see more results.</p>
          <img src="{% static 'assets/img/empty.svg' %}" alt="No invoices illustration">
          <div class="mt-4">
            <button type="button" class="btn btn-primary btn-lg" data-bs-toggle="modal" data-bs-target="#createInvoiceModal">
              <i class="bi bi-plus-circle me-2"></i> Create Your First Invoice
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Create Invoice Modal -->
  <div class="modal fade" id="createInvoiceModal" tabindex="-1" aria-labelledby="createInvoiceModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <form action="{% url 'invoices' %}" method="post">
          {% csrf_token %}
          
          <div class="modal-header">
            <h5 class="modal-title" id="createInvoiceModalLabel">Create New Invoice</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          
          <div class="modal-body">
            {% if form.errors %}
            <div class="alert alert-danger" role="alert">
              <strong>Please correct the following errors:</strong>
              <ul class="mb-0 mt-2">
                {% for field, errors in form.errors.items %}
                  {% for error in errors %}
                  <li>{{ field }}: {{ error }}</li>
                  {% endfor %}
                {% endfor %}
              </ul>
            </div>
            {% endif %}
            
            {{ form.as_p }}
          </div>
          
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary">Create Invoice</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</main>
{% endblock %}