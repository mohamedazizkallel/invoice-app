{% extends 'partials/base.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block css %}
<style>
  .page-header {
    background: white;
    padding: 1.5rem;
    border-radius: 0.5rem;
    margin-bottom: 1.5rem;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
  }
  
  .filter-section {
    background: white;
    border-radius: 0.5rem;
    padding: 1rem;
    margin-bottom: 1.5rem;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
  }
  
  .table-container {
    background: white;
    border-radius: 0.5rem;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    padding: 1.5rem;
  }
  
  .status-badge {
    padding: 0.35rem 0.75rem;
    border-radius: 0.25rem;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
  }
  
  .status-current {
    background-color: #d1ecf1;
    color: #0c5460;
  }
  
  .status-overdue {
    background-color: #f8d7da;
    color: #721c24;
  }
  
  .status-paid {
    background-color: #d4edda;
    color: #155724;
  }
  
  .status-draft {
    background-color: #e2e3e5;
    color: #383d41;
  }
  
  .invoice-row {
    cursor: pointer;
    transition: background-color 0.15s ease-in-out;
  }
  
  .invoice-row:hover {
    background-color: #f8f9fa;
  }
  
  .empty-state {
    text-align: center;
    padding: 3rem 1rem;
  }
  
  .empty-state img {
    max-width: 100%;
    height: auto;
    margin-top: 1.5rem;
  }
  
  .empty-state h3 {
    color: #6c757d;
    font-weight: 400;
    margin-bottom: 1rem;
  }

  .import-export-card {
    background: #f8f9fa;
    border: 2px dashed #dee2e6;
    border-radius: 0.5rem;
    padding: 1.5rem;
    text-align: center;
    margin-bottom: 1.5rem;
  }
  
  .modal-content {
    animation: fadeSlide 0.25s ease-out;
    border: none;
  }

  @keyframes fadeSlide {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .modal-body {
    overflow-y: auto !important;
  }
  .modal-dialog-scrollable .modal-body {
    max-height: 70vh; /* limit height so it becomes scrollable */
    }

</style>
{% endblock %}

{% block main %}
<main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
  <!-- Page Header -->
  <div class="page-header d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center">
    <h1 class="h2 mb-0">Invoices</h1>
    <div class="btn-toolbar">
      <div class="btn-group me-2">
        <button type="button" class="btn btn-outline-secondary" onclick="window.print()">
          <i class="bi bi-printer me-1"></i> Print
        </button>
        <a href="{% url 'export_invoices' %}" class="btn btn-outline-secondary">
          <i class="bi bi-download me-1"></i> Export to Excel
        </a>
      </div>
      <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createInvoiceModal">
        <i class="bi bi-plus-circle me-1"></i> Create Invoice
      </button>
    </div>
  </div>

  <!-- Import/Export Card -->
  <div class="import-export-card">
    <div class="row align-items-center">
      <div class="col-md-6 text-md-start text-center mb-3 mb-md-0">
        <h5 class="mb-2">
          <i class="bi bi-upload me-2"></i> Import Invoices from Excel
        </h5>
        <p class="text-muted mb-0">Upload an Excel file (.xlsx, .xls) to import multiple invoices at once</p>
      </div>
      <div class="col-md-6 text-md-end text-center">
        <button type="button" class="btn btn-success me-2" data-bs-toggle="modal" data-bs-target="#importInvoiceModal">
          <i class="bi bi-file-earmark-arrow-up me-1"></i> Import from Excel
        </button>
        <a href="{% url 'download_invoice_template' %}" class="btn btn-outline-secondary">
          <i class="bi bi-file-earmark-spreadsheet me-1"></i> Download Template
        </a>
      </div>
    </div>
  </div>

  <!-- Filter Section -->
  <div class="filter-section">
    <form method="get" class="row g-3 align-items-end">
      <div class="col-md-3">
        <label for="filterSearch" class="form-label">Search</label>
        <input type="text" class="form-control" id="filterSearch" name="search" placeholder="Search invoices..." value="{{ request.GET.search }}">
      </div>
      <div class="col-md-3">
        <label for="filterStatus" class="form-label">Status</label>
        <select class="form-select" id="filterStatus" name="status">
          <option value="">All Statuses</option>
          <option value="DRAFT" {% if request.GET.status == "DRAFT" %}selected{% endif %}>Draft</option>
          <option value="CURRENT" {% if request.GET.status == "CURRENT" %}selected{% endif %}>Current</option>
          <option value="OVERDUE" {% if request.GET.status == "OVERDUE" %}selected{% endif %}>Overdue</option>
          <option value="PAID" {% if request.GET.status == "PAID" %}selected{% endif %}>Paid</option>
        </select>
      </div>
      <div class="col-md-3">
        <label for="filterClient" class="form-label">Client</label>
        <select class="form-select" id="filterClient" name="client">
          <option value="">All Clients</option>
          {% for client in clients %}
          <option value="{{ client.id }}" {% if request.GET.client == client.id|stringformat:"s" %}selected{% endif %}>
            {{ client.clientName }}
          </option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-3">
        <button type="submit" class="btn btn-primary w-100">
          <i class="bi bi-funnel me-1"></i> Apply Filter
        </button>
      </div>
    </form>
  </div>

  {% if invoices|length > 0 %}
  <!-- Invoices Table -->
  <div class="table-container">
    <div class="table-responsive">
      <table class="table table-hover mb-0">
        <thead class="table-light">
          <tr>
            <th scope="col">Invoice #</th>
            <th scope="col">Title</th>
            <th scope="col">Client</th>
            <th scope="col">Date Created</th>
            <th scope="col">Status</th>
            <th scope="col" class="text-end">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for invoice in invoices %}
          <tr class="invoice-row">
            <td class="align-middle">
              <a href="{% url 'invoice_detail' invoice.id %}" class="text-decoration-none fw-bold">
                INV-{{ invoice.uniqueId|default:invoice.id }}
              </a>
            </td>
            <td class="align-middle">{{ invoice.title }}</td>
            <td class="align-middle">{{ invoice.client.clientName|default:"No Client" }}</td>
            <td class="align-middle">{{ invoice.date_created|date:"M d, Y"|default:"N/A" }}</td>
            <td class="align-middle">
              <span class="status-badge status-{{ invoice.status|lower }}">{{ invoice.status }}</span>
            </td>
            <td class="align-middle text-end">
              <div class="btn-group btn-group-sm">
                <a href="{% url 'invoice_detail' invoice.id %}" class="btn btn-outline-primary" title="View">
                  <i class="bi bi-eye"></i>
                </a>
                <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#editInvoiceModal{{ invoice.id }}" title="Edit">
                  <i class="bi bi-pencil"></i>
                </button>
                <button type="button" class="btn btn-outline-danger" title="Delete" data-bs-toggle="modal" data-bs-target="#deleteInvoiceModal{{ invoice.id }}">
                  <i class="bi bi-trash"></i>
                </button>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Pagination -->
    {% if is_paginated %}
    <nav aria-label="Invoice pagination" class="mt-4">
      <ul class="pagination justify-content-center mb-0">
        {% if page_obj.has_previous %}
        <li class="page-item">
          <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}{% if request.GET.client %}&client={{ request.GET.client }}{% endif %}">Previous</a>
        </li>
        {% else %}
        <li class="page-item disabled">
          <span class="page-link">Previous</span>
        </li>
        {% endif %}

        {% for num in page_obj.paginator.page_range %}
        {% if page_obj.number == num %}
        <li class="page-item active"><span class="page-link">{{ num }}</span></li>
        {% else %}
        <li class="page-item"><a class="page-link" href="?page={{ num }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}{% if request.GET.client %}&client={{ request.GET.client }}{% endif %}">{{ num }}</a></li>
        {% endif %}
        {% endfor %}

        {% if page_obj.has_next %}
        <li class="page-item">
          <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}{% if request.GET.client %}&client={{ request.GET.client }}{% endif %}">Next</a>
        </li>
        {% else %}
        <li class="page-item disabled">
          <span class="page-link">Next</span>
        </li>
        {% endif %}
      </ul>
    </nav>
    {% endif %}
  </div>
  {% else %}
  <!-- Empty State -->
  <div class="table-container">
    <div class="empty-state">
      <div class="row justify-content-center">
        <div class="col-lg-6">
          <h3>No Invoices Found</h3>
          <p class="text-muted">Get started by creating your first invoice or adjust your filters to see more results.</p>
          <img src="{% static 'assets/img/empty.svg' %}" alt="No invoices illustration">
          <div class="mt-4">
            <button type="button" class="btn btn-primary btn-lg" data-bs-toggle="modal" data-bs-target="#createInvoiceModal">
              <i class="bi bi-plus-circle me-2"></i> Create Your First Invoice
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Create Invoice Modal -->
  <div class="modal fade" id="createInvoiceModal" tabindex="-1" aria-labelledby="createInvoiceModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content shadow-lg rounded-4">
        <form action="{% url 'invoice_create' %}" method="post" id="createInvoiceForm">
          {% csrf_token %}
          <input type="hidden" name="products_data" id="products_data">
          
          <!-- Modal Header -->
          <div class="modal-header border-0 pb-0">
            <h5 class="modal-title fw-semibold" id="createInvoiceModalLabel">
              <i class="bi bi-file-earmark-plus me-2 text-primary"></i> Create New Invoice
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          
          <!-- Modal Body -->
          <div class="modal-body pt-2">
            {% if form.errors %}
            <div class="alert alert-danger rounded-3" role="alert">
              <strong><i class="bi bi-exclamation-triangle me-2"></i> Please correct the following errors:</strong>
              <ul class="mt-2 mb-0">
                {% for field, errors in form.errors.items %}
                  {% for error in errors %}
                  <li>{{ field }}: {{ error }}</li>
                  {% endfor %}
                {% endfor %}
              </ul>
            </div>
            {% endif %}
            
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label fw-semibold">Invoice Title</label>
                <input type="text" class="form-control" name="title" required>
              </div>

              <div class="col-md-6">
                <label class="form-label fw-semibold">Client</label>
                <select class="form-select" name="client" required>
                  <option value="">Select Client</option>
                  {% for client in clients %}
                  <option value="{{ client.id }}">{{ client.clientname }}</option>
                  {% endfor %}
                </select>
              </div>

              <div class="col-md-3">
                <label class="form-label fw-semibold">Status</label>
                <select class="form-select" name="status">
                  <option value="CURRENT">Current</option>
                  <option value="OVERDUE">Overdue</option>
                  <option value="PAID">Paid</option>
                </select>
              </div>

              <div class="col-md-3">
                <label class="form-label fw-semibold">TVA (%)</label>
                <input type="number" step="0.01" class="form-control" name="tva" value="19.00">
              </div>

              <div class="col-md-3">
                <label class="form-label fw-semibold">Timbre Fiscal (D)</label>
                <input type="number" step="0.001" class="form-control" name="timbre_fiscal" value="1.000">
              </div>

              <div class="col-md-3">
                <label class="form-label fw-semibold">Discount (%)</label>
                <input type="number" step="0.01" class="form-control" name="discount" value="0.00">
              </div>

              <div class="col-12">
                <label class="form-label fw-semibold">Notes</label>
                <textarea class="form-control" name="notes" rows="2"></textarea>
              </div>

              <!-- Products Section -->
              <div class="col-12">
                <hr class="my-3">
                <div class="d-flex justify-content-between align-items-center mb-3">
                  <h6 class="mb-0 fw-semibold">
                    <i class="bi bi-box-seam me-2"></i> Add Products
                  </h6>
                  <button type="button" class="btn btn-sm btn-outline-primary" id="addProductRow">
                    <i class="bi bi-plus-circle me-1"></i> Add Product
                  </button>
                </div>

                <div id="productsContainer">
                  <!-- Product rows will be added here -->
                </div>

                <div class="alert alert-info mt-3" role="alert">
                  <small>
                    <i class="bi bi-info-circle me-1"></i>
                    Click "Add Product" to select products and specify quantities. The system will check available inventory.
                  </small>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Modal Footer -->
          <div class="modal-footer border-0">
            <button type="button" class="btn btn-light px-4" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary px-4">
              <i class="bi bi-check-circle me-1"></i> Create Invoice
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Import Invoice Modal -->
  <div class="modal fade" id="importInvoiceModal" tabindex="-1" aria-labelledby="importInvoiceModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content shadow-lg rounded-4">
        <form action="{% url 'import_invoices' %}" method="post" enctype="multipart/form-data" id="importInvoiceForm">
          {% csrf_token %}
          
          <!-- Modal Header -->
          <div class="modal-header border-0 pb-0">
            <h5 class="modal-title fw-semibold" id="importInvoiceModalLabel">
              <i class="bi bi-file-earmark-arrow-up me-2 text-success"></i> Import Invoices from Excel
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          
          <!-- Modal Body -->
          <div class="modal-body pt-2">
            <div class="alert alert-info rounded-3" role="alert">
              <strong><i class="bi bi-info-circle me-2"></i> File Requirements:</strong>
              <ul class="mb-0 mt-2">
                <li>File format: .xlsx or .xls</li>
                <li>Required columns: Title, Client Name</li>
                <li>Optional columns: Product Titles (comma-separated), Status, Notes</li>
                <li>Download our template to ensure correct formatting</li>
              </ul>
            </div>
            
            <div class="mb-3">
              <label for="invoiceExcelFile" class="form-label fw-semibold">Select Excel File</label>
              <input class="form-control" type="file" id="invoiceExcelFile" name="excel_file" accept=".xlsx,.xls" required>
              <div class="form-text">Maximum file size: 5MB</div>
            </div>

            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="updateExistingInvoice" name="update_existing">
              <label class="form-check-label" for="updateExistingInvoice">
                Update existing invoices (match by Title)
              </label>
            </div>
          </div>
          
          <!-- Modal Footer -->
          <div class="modal-footer border-0">
            <button type="button" class="btn btn-light px-4" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-success px-4">
              <i class="bi bi-upload me-1"></i> Import Invoices
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Edit and Delete Modals for Each Invoice -->
  {% for invoice in invoices %}
  
  <!-- Edit Invoice Modal -->
  <div class="modal fade" id="editInvoiceModal{{ invoice.id }}" tabindex="-1" aria-labelledby="editInvoiceModalLabel{{ invoice.id }}" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content shadow-lg rounded-4">
        <form action="{% url 'invoice_edit' invoice.id %}" method="post" id="editInvoiceForm{{ invoice.id }}">
          {% csrf_token %}
          <input type="hidden" name="products_data" id="edit_products_data_{{ invoice.id }}">

          <!-- Modal Header -->
          <div class="modal-header border-0 pb-0">
            <h5 class="modal-title fw-semibold" id="editInvoiceModalLabel{{ invoice.id }}">
              <i class="bi bi-pencil me-2 text-secondary"></i> Edit Invoice
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>

          <!-- Modal Body -->
          <div class="modal-body pt-2">
            {% if form.errors %}
            <div class="alert alert-danger rounded-3" role="alert">
              <strong><i class="bi bi-exclamation-triangle me-2"></i> Please correct the following errors:</strong>
              <ul class="mt-2 mb-0">
                {% for field, errors in form.errors.items %}
                  {% for error in errors %}
                  <li>{{ field }}: {{ error }}</li>
                  {% endfor %}
                {% endfor %}
              </ul>
            </div>
            {% endif %}

            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label fw-semibold">Invoice Title</label>
                <input type="text" class="form-control" name="title" value="{{ invoice.title }}" required>
              </div>

              <div class="col-md-6">
                <label class="form-label fw-semibold">Client</label>
                <select class="form-select" name="client" required>
                  {% for client in clients %}
                  <option value="{{ client.id }}" {% if invoice.client.id == client.id %}selected{% endif %}>
                    {{ client.clientname }}
                  </option>
                  {% endfor %}
                </select>
              </div>

              <div class="col-md-3">
                <label class="form-label fw-semibold">Status</label>
                <select class="form-select" name="status">
                  <option value="CURRENT" {% if invoice.status == "CURRENT" %}selected{% endif %}>Current</option>
                  <option value="OVERDUE" {% if invoice.status == "OVERDUE" %}selected{% endif %}>Overdue</option>
                  <option value="PAID" {% if invoice.status == "PAID" %}selected{% endif %}>Paid</option>
                </select>
              </div>

              <div class="col-md-3">
                <label class="form-label fw-semibold">TVA (%)</label>
                <input type="number" step="0.01" class="form-control" name="tva" value="{{ invoice.tva|default:19.00 }}">
              </div>

              <div class="col-md-3">
                <label class="form-label fw-semibold">Timbre Fiscal (D)</label>
                <input type="number" step="0.001" class="form-control" name="timbre_fiscal" value="{{ invoice.timbre_fiscal|default:1.000 }}">
              </div>

              <div class="col-md-3">
                <label class="form-label fw-semibold">Discount (%)</label>
                <input type="number" step="0.01" class="form-control" name="discount" value="{{ invoice.discount|default:0.00 }}">
              </div>

              <div class="col-12">
                <label class="form-label fw-semibold">Notes</label>
                <textarea class="form-control" name="notes" rows="2">{{ invoice.notes }}</textarea>
              </div>

              <!-- Products Section -->
              <div class="col-12">
                <hr class="my-3">
                <div class="d-flex justify-content-between align-items-center mb-3">
                  <h6 class="mb-0 fw-semibold">
                    <i class="bi bi-box-seam me-2"></i> Add/Edit Products
                  </h6>
                  <button type="button" class="btn btn-sm btn-outline-primary" id="addEditProductRow_{{ invoice.id }}">
                    <i class="bi bi-plus-circle me-1"></i> Add Product
                  </button>
                </div>

                <div id="editProductsContainer_{{ invoice.id }}">
                  <!-- Preloaded Product Rows -->
                  {% for product in invoice.product.all %}
                  <div class="card mb-2">
                    <div class="card-body p-3">
                      <div class="row g-2 align-items-end">
                        <div class="col-md-6">
                          <label class="form-label small mb-1">Product</label>
                          <select class="form-select form-select-sm product-select" data-row="{{ forloop.counter0 }}">
                            {% for p in products %}
                            <option value="{{ p.id }}" {% if p.id == product.id %}selected{% endif %}>
                              {{ p.title }} (Stock: {{ p.quantity }}) - {{ p.currency }} {{ p.price }}
                            </option>
                            {% endfor %}
                          </select>
                        </div>
                        <div class="col-md-3">
                          <label class="form-label small mb-1">Quantity</label>
                          <input type="number" class="form-control form-control-sm quantity-input" data-row="{{ forloop.counter0 }}" min="1" step="1" value="{{ product.quantity }}">
                        </div>
                        <div class="col-md-2">
                          <label class="form-label small mb-1">Total</label>
                          <input type="text" class="form-control form-control-sm line-total" data-row="{{ forloop.counter0 }}" readonly>
                        </div>
                        <div class="col-md-1">
                          <button type="button" class="btn btn-sm btn-outline-danger w-100 remove-product" data-row="{{ forloop.counter0 }}">
                            <i class="bi bi-trash"></i>
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                  {% endfor %}
                </div>

                <div class="alert alert-info mt-3" role="alert">
                  <small>
                    <i class="bi bi-info-circle me-1"></i>
                    Click "Add Product" to select products and specify quantities. The system will check available inventory.
                  </small>
                </div>
              </div>
            </div>
          </div>

          <!-- Modal Footer -->
          <div class="modal-footer border-0">
            <button type="button" class="btn btn-light px-4" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary px-4">
              <i class="bi bi-check-circle me-1"></i> Save Changes
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Delete Invoice Modal -->
  <div class="modal fade" id="deleteInvoiceModal{{ invoice.id }}" tabindex="-1" aria-labelledby="deleteInvoiceModalLabel{{ invoice.id }}" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content shadow-lg rounded-4">
        <form action="{% url 'invoice_delete' invoice.id %}" method="post">
          {% csrf_token %}

          <!-- Modal Header -->
          <div class="modal-header border-0 pb-0">
            <h5 class="modal-title fw-semibold text-danger" id="deleteInvoiceModalLabel{{ invoice.id }}">
              <i class="bi bi-trash me-2"></i> Delete Invoice
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>

          <!-- Modal Body -->
          <div class="modal-body pt-2">
            <div class="alert alert-danger rounded-3" role="alert">
              <i class="bi bi-exclamation-triangle me-2"></i>
              <strong>Warning!</strong> This action cannot be undone.
            </div>
            <p class="mb-0">Are you sure you want to delete the invoice <strong>"{{ invoice.title }}"</strong>?</p>
          </div>

          <!-- Modal Footer -->
          <div class="modal-footer border-0">
            <button type="button" class="btn btn-light px-4" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-danger px-4">
              <i class="bi bi-trash me-1"></i> Delete Invoice
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  {% endfor %}

</main>

<script>
// ==================== PRODUCT QUANTITY SELECTOR ====================
let productRowCounter = 0;

// Available products from Django
const availableProducts = [
  {% for product in products %}
  {
    id: {{ product.id }},
    title: "{{ product.title|escapejs }}",
    price: {{ product.price|default:0 }},
    currency: "{{ product.currency|default:'TND' }}",
    available_quantity: {{ product.quantity|default:0 }}
  }{% if not forloop.last %},{% endif %}
  {% endfor %}
];

document.getElementById('addProductRow')?.addEventListener('click', function() {
  const container = document.getElementById('productsContainer');
  const rowId = `product_row_${productRowCounter}`;
  
  const row = document.createElement('div');
  row.className = 'card mb-2';
  row.id = rowId;
  row.innerHTML = `
    <div class="card-body p-3">
      <div class="row g-2 align-items-end">
        <div class="col-md-6">
          <label class="form-label small mb-1">Product</label>
          <select class="form-select form-select-sm product-select" data-row="${productRowCounter}">
            <option value="">Select Product</option>
            ${availableProducts.map(p => `
              <option value="${p.id}" data-price="${p.price}" data-stock="${p.available_quantity}" data-currency="${p.currency}">
                ${p.title} (Stock: ${p.available_quantity}) - ${p.currency} ${p.price.toFixed(3)}
              </option>
            `).join('')}
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label small mb-1">Quantity</label>
          <input type="number" class="form-control form-control-sm quantity-input" data-row="${productRowCounter}" min="1" step="1" value="1">
        </div>
        <div class="col-md-2">
          <label class="form-label small mb-1">Total</label>
          <input type="text" class="form-control form-control-sm line-total" data-row="${productRowCounter}" readonly>
        </div>
        <div class="col-md-1">
          <button type="button" class="btn btn-sm btn-outline-danger w-100 remove-product" data-row="${productRowCounter}">
            <i class="bi bi-trash"></i>
          </button>
        </div>
      </div>
      <div class="stock-warning mt-2" style="display:none;">
        <small class="text-danger">
          <i class="bi bi-exclamation-triangle me-1"></i>
          <span class="warning-text"></span>
        </small>
      </div>
    </div>
  `;
  
  container.appendChild(row);
  
  // Add event listeners
  const productSelect = row.querySelector('.product-select');
  const quantityInput = row.querySelector('.quantity-input');
  const lineTotalInput = row.querySelector('.line-total');
  const removeBtn = row.querySelector('.remove-product');
  const stockWarning = row.querySelector('.stock-warning');
  const warningText = row.querySelector('.warning-text');
  
  function updateLineTotal() {
    const selectedOption = productSelect.options[productSelect.selectedIndex];
    if (selectedOption.value) {
      const price = parseFloat(selectedOption.dataset.price);
      const stock = parseFloat(selectedOption.dataset.stock);
      const quantity = parseInt(quantityInput.value) || 0;
      const currency = selectedOption.dataset.currency;
      
      const total = price * quantity;
      lineTotalInput.value = `${currency} ${total.toFixed(3)}`;
      
      // Check stock
      if (quantity > stock) {
        stockWarning.style.display = 'block';
        warningText.textContent = `Insufficient stock! Available: ${stock}`;
      } else {
        stockWarning.style.display = 'none';
      }
    } else {
      lineTotalInput.value = '';
      stockWarning.style.display = 'none';
    }
  }
  
  productSelect.addEventListener('change', updateLineTotal);
  quantityInput.addEventListener('input', updateLineTotal);
  
  removeBtn.addEventListener('click', function() {
    row.remove();
  });
  
  productRowCounter++;
});

// Form submission
document.getElementById('createInvoiceForm')?.addEventListener('submit', function(e) {
  e.preventDefault();
  
  // Collect product data
  const products = [];
  const productSelects = document.querySelectorAll('.product-select');
  const quantityInputs = document.querySelectorAll('.quantity-input');
  
  let hasError = false;
  
  productSelects.forEach((select, index) => {
    if (select.value) {
      const quantity = parseInt(quantityInputs[index].value);
      const selectedOption = select.options[select.selectedIndex];
      const availableStock = parseFloat(selectedOption.dataset.stock);
      
      if (quantity > availableStock) {
        alert(`Insufficient stock for ${selectedOption.text.split('(')[0].trim()}`);
        hasError = true;
        return;
      }
      
      if (quantity <= 0) {
        alert('Quantity must be greater than 0');
        hasError = true;
        return;
      }
      
      products.push({
        product_id: parseInt(select.value),
        quantity: quantity
      });
    }
  });
  
  if (hasError) return;
  
  if (products.length === 0) {
    alert('Please add at least one product to the invoice.');
    return;
  }
  
  // Set products data as JSON
  document.getElementById('products_data').value = JSON.stringify(products);
  
  // Submit form
  this.submit();
});

// Auto-add one product row on modal open
document.getElementById('createInvoiceModal')?.addEventListener('shown.bs.modal', function() {
  if (productRowCounter === 0) {
    document.getElementById('addProductRow')?.click();
  }
});

// Display selected file name
document.getElementById('invoiceExcelFile')?.addEventListener('change', function(e) {
  const fileName = e.target.files[0]?.name;
  if (fileName) {
    const label = document.querySelector('label[for="invoiceExcelFile"]');
    if (label) {
      label.textContent = `Selected: ${fileName}`;
    }
  }
});
</script>

<style>
  .product-select, .quantity-input {
    font-size: 0.875rem;
  }
  
  .line-total {
    background-color: #f8f9fa;
    font-weight: 600;
  }
  
  .stock-warning {
    padding: 0.5rem;
    background: #fff3cd;
    border-radius: 0.25rem;
  }
  
  #productsContainer .card {
    border-left: 3px solid #0d6efd;
  }
</style>

{% endblock %}