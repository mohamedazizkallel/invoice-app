{% extends 'partials/base.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block css %}
<style>
  .page-header {
    background: white;
    padding: 1.5rem;
    border-radius: 0.5rem;
    margin-bottom: 1.5rem;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
  }
  
  .filter-section {
    background: white;
    border-radius: 0.5rem;
    padding: 1rem;
    margin-bottom: 1.5rem;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
  }
  
  .table-container {
    background: white;
    border-radius: 0.5rem;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    padding: 1.5rem;
  }
  
  .product-row {
    cursor: pointer;
    transition: background-color 0.15s ease-in-out;
  }
  
  .product-row:hover {
    background-color: #f8f9fa;
  }
  
  .empty-state {
    text-align: center;
    padding: 3rem 1rem;
  }
  
  .empty-state img {
    max-width: 100%;
    height: auto;
    margin-top: 1.5rem;
  }
  
  .empty-state h3 {
    color: #6c757d;
    font-weight: 400;
    margin-bottom: 1rem;
  }
  
  .import-export-card {
    background: #f8f9fa;
    border: 2px dashed #dee2e6;
    border-radius: 0.5rem;
    padding: 1.5rem;
    text-align: center;
    margin-bottom: 1.5rem;
  }
  
  .modal-content {
    animation: fadeSlide 0.25s ease-out;
    border: none;
  }

  @keyframes fadeSlide {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
</style>
{% endblock %}

{% block main %}
<main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
  <!-- Page Header -->
  <div class="page-header d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center">
    <h1 class="h2 mb-0">Products</h1>
    <div class="btn-toolbar">
      <div class="btn-group me-2">
        <button type="button" class="btn btn-outline-secondary" onclick="window.print()">
          <i class="bi bi-printer me-1"></i> Print
        </button>
        <a href="{% url 'export_products' %}" class="btn btn-outline-secondary">
          <i class="bi bi-download me-1"></i> Export to Excel
        </a>
      </div>
      <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addProductModal">
        <i class="bi bi-plus-circle me-1"></i> Add Product
      </button>
    </div>
  </div>

  <!-- Import/Export Card -->
  <div class="import-export-card">
    <div class="row align-items-center">
      <div class="col-md-6 text-md-start text-center mb-3 mb-md-0">
        <h5 class="mb-2">
          <i class="bi bi-upload me-2"></i> Import Products from Excel
        </h5>
        <p class="text-muted mb-0">Upload an Excel file (.xlsx, .xls) to import multiple products at once</p>
      </div>
      <div class="col-md-6 text-md-end text-center">
        <button type="button" class="btn btn-success me-2" data-bs-toggle="modal" data-bs-target="#importModal">
          <i class="bi bi-file-earmark-arrow-up me-1"></i> Import from Excel
        </button>
        <a href="{% url 'download_product_template' %}" class="btn btn-outline-secondary">
          <i class="bi bi-file-earmark-spreadsheet me-1"></i> Download Template
        </a>
      </div>
    </div>
  </div>

  <!-- Filter Section -->
  <div class="filter-section">
    <form method="get" class="row g-3 align-items-end">
      <div class="col-md-5">
        <label for="filterSearch" class="form-label">Search Products</label>
        <input type="text" class="form-control" id="filterSearch" name="search" placeholder="Search by title or description" value="{{ request.GET.search }}">
      </div>
      <div class="col-md-4">
        <label for="filterSort" class="form-label">Sort By</label>
        <select class="form-select" id="filterSort" name="sort">
          <option value="title" {% if request.GET.sort == "title" %}selected{% endif %}>Title (A-Z)</option>
          <option value="-title" {% if request.GET.sort == "-title" %}selected{% endif %}>Title (Z-A)</option>
          <option value="price" {% if request.GET.sort == "price" %}selected{% endif %}>Price (Low to High)</option>
          <option value="-price" {% if request.GET.sort == "-price" %}selected{% endif %}>Price (High to Low)</option>
        </select>
      </div>
      <div class="col-md-3">
        <button type="submit" class="btn btn-primary w-100">
          <i class="bi bi-funnel me-1"></i> Apply Filter
        </button>
      </div>
    </form>
  </div>

  {% if products|length > 0 %}
  <!-- Products Table -->
  <div class="table-container">
    <div class="table-responsive">
      <table class="table table-hover mb-0">
        <thead class="table-light">
          <tr>
            <th scope="col">Product ID</th>
            <th scope="col">Title</th>
            <th scope="col">Description</th>
            <th scope="col" class="text-center">Currency</th>
            <th scope="col" class="text-end">Price</th>
            <th scope="col" class="text-center">Quantity</th>
            <th scope="col" class="text-end">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for product in products %}
          <tr class="product-row">
            <td class="align-middle">
              <strong>PRD-{{ product.id|stringformat:"04d" }}</strong>
            </td>
            <td class="align-middle">{{ product.title }}</td>
            <td class="align-middle">
              {% if product.description %}
                {{ product.description|truncatewords:10 }}
              {% else %}
                <span class="text-muted">No description</span>
              {% endif %}
            </td>
            <td class="align-middle text-center">
              <span class="badge bg-secondary">{{ product.currency|default:"ZAR" }}</span>
            </td>
            <td class="align-middle text-end">{{ product.currency|default:"R" }} {{ product.price|floatformat:2 }}</td>
            <td class="align-middle text-center">
              {% if product.quantity == 0 %}
                <span class="badge bg-danger">Out of Stock</span>
              {% elif product.quantity < 10 %}
                <span class="badge bg-warning text-dark">{{ product.quantity }}</span>
              {% else %}
                <span class="badge bg-success">{{ product.quantity }}</span>
              {% endif %}
            </td>
            <td class="align-middle text-end">
              <div class="btn-group btn-group-sm">
                <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#viewProductModal{{ product.id }}" title="View">
                  <i class="bi bi-eye"></i>
                </button>
                <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#editProductModal{{ product.id }}" title="Edit">
                  <i class="bi bi-pencil"></i>
                </button>
                <button type="button" class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteProductModal{{ product.id }}" title="Delete">
                  <i class="bi bi-trash"></i>
                </button>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Pagination -->
    {% if is_paginated %}
    <nav aria-label="Product pagination" class="mt-4">
      <ul class="pagination justify-content-center mb-0">
        {% if page_obj.has_previous %}
        <li class="page-item">
          <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.sort %}&sort={{ request.GET.sort }}{% endif %}">Previous</a>
        </li>
        {% else %}
        <li class="page-item disabled">
          <span class="page-link">Previous</span>
        </li>
        {% endif %}

        {% for num in page_obj.paginator.page_range %}
        {% if page_obj.number == num %}
        <li class="page-item active"><span class="page-link">{{ num }}</span></li>
        {% else %}
        <li class="page-item"><a class="page-link" href="?page={{ num }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.sort %}&sort={{ request.GET.sort }}{% endif %}">{{ num }}</a></li>
        {% endif %}
        {% endfor %}

        {% if page_obj.has_next %}
        <li class="page-item">
          <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.sort %}&sort={{ request.GET.sort }}{% endif %}">Next</a>
        </li>
        {% else %}
        <li class="page-item disabled">
          <span class="page-link">Next</span>
        </li>
        {% endif %}
      </ul>
    </nav>
    {% endif %}
  </div>
  {% else %}
  <!-- Empty State -->
  <div class="table-container">
    <div class="empty-state">
      <div class="row justify-content-center">
        <div class="col-lg-6">
          <h3>No Products Found</h3>
          <p class="text-muted">Get started by adding products manually or importing them from an Excel file.</p>
          <img src="{% static 'assets/img/empty.svg' %}" alt="No products illustration">
          <div class="mt-4">
            <button type="button" class="btn btn-primary btn-lg me-2" data-bs-toggle="modal" data-bs-target="#addProductModal">
              <i class="bi bi-plus-circle me-2"></i> Add Product
            </button>
            <button type="button" class="btn btn-success btn-lg" data-bs-toggle="modal" data-bs-target="#importModal">
              <i class="bi bi-file-earmark-arrow-up me-2"></i> Import from Excel
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Add Product Modal -->
  <div class="modal fade" id="addProductModal" tabindex="-1" aria-labelledby="addProductModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content shadow-lg rounded-4">
        <form action="{% url 'add_product' %}" method="post" enctype="multipart/form-data">
          {% csrf_token %}

          <!-- Modal Header -->
          <div class="modal-header border-0 pb-0">
            <h5 class="modal-title fw-semibold" id="addProductModalLabel">
              <i class="bi bi-box-seam me-2 text-primary"></i> Add New Product
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>

          <!-- Modal Body -->
          <div class="modal-body pt-2">
            {% if form.errors %}
            <div class="alert alert-danger rounded-3" role="alert">
              <strong><i class="bi bi-exclamation-triangle me-2"></i> Please correct the following errors:</strong>
              <ul class="mt-2 mb-0">
                {% for field, errors in form.errors.items %}
                  {% for error in errors %}
                  <li>{{ field }}: {{ error }}</li>
                  {% endfor %}
                {% endfor %}
              </ul>
            </div>
            {% endif %}

            <div class="row g-3">
              {% for field in form %}
              <div class="col-md-6">
                <label class="form-label fw-semibold">{{ field.label }}</label>
                {{ field }}
                {% if field.help_text %}
                <small class="form-text text-muted">{{ field.help_text }}</small>
                {% endif %}
                {% if field.errors %}
                <div class="text-danger small mt-1">
                  {% for error in field.errors %}
                    {{ error }}
                  {% endfor %}
                </div>
                {% endif %}
              </div>
              {% endfor %}
            </div>
          </div>

          <!-- Modal Footer -->
          <div class="modal-footer border-0">
            <button type="button" class="btn btn-light px-4" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary px-4">
              <i class="bi bi-check-circle me-1"></i> Add Product
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Import Products Modal -->
  <div class="modal fade" id="importModal" tabindex="-1" aria-labelledby="importModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content shadow-lg rounded-4">
        <form action="{% url 'import_products' %}" method="post" enctype="multipart/form-data" id="importForm">
          {% csrf_token %}
          
          <!-- Modal Header -->
          <div class="modal-header border-0 pb-0">
            <h5 class="modal-title fw-semibold" id="importModalLabel">
              <i class="bi bi-file-earmark-arrow-up me-2 text-success"></i> Import Products from Excel
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          
          <!-- Modal Body -->
          <div class="modal-body pt-2">
            <div class="alert alert-info rounded-3" role="alert">
              <strong><i class="bi bi-info-circle me-2"></i> File Requirements:</strong>
              <ul class="mb-0 mt-2">
                <li>File format: .xlsx or .xls</li>
                <li>Required columns: Title, Currency, Description, Price, Quantity</li>
                <li>Download our template to ensure correct formatting</li>
              </ul>
            </div>
            
            <div class="mb-3">
              <label for="excelFile" class="form-label fw-semibold">Select Excel File</label>
              <input class="form-control" type="file" id="excelFile" name="excel_file" accept=".xlsx,.xls" required>
              <div class="form-text">Maximum file size: 5MB</div>
            </div>

            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="updateExisting" name="update_existing">
              <label class="form-check-label" for="updateExisting">
                Update existing products (match by Title)
              </label>
            </div>
          </div>
          
          <!-- Modal Footer -->
          <div class="modal-footer border-0">
            <button type="button" class="btn btn-light px-4" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-success px-4">
              <i class="bi bi-upload me-1"></i> Import Products
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- View, Edit, and Delete Modals for Each Product -->
  {% for product in products %}
  
  <!-- View Product Modal -->
  <div class="modal fade" id="viewProductModal{{ product.id }}" tabindex="-1" aria-labelledby="viewProductModalLabel{{ product.id }}" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content shadow-lg rounded-4">
        <!-- Modal Header -->
        <div class="modal-header border-0 pb-0">
          <h5 class="modal-title fw-semibold" id="viewProductModalLabel{{ product.id }}">
            <i class="bi bi-eye me-2 text-primary"></i> Product Details
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        
        <!-- Modal Body -->
        <div class="modal-body pt-2">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label fw-semibold text-muted">Product ID</label>
              <p class="form-control-plaintext">PRD-{{ product.id|stringformat:"04d" }}</p>
            </div>
            <div class="col-md-6">
              <label class="form-label fw-semibold text-muted">Title</label>
              <p class="form-control-plaintext">{{ product.title }}</p>
            </div>
            <div class="col-md-6">
              <label class="form-label fw-semibold text-muted">Currency</label>
              <p class="form-control-plaintext">
                <span class="badge bg-secondary">{{ product.currency|default:"TND" }}</span>
              </p>
            </div>
            <div class="col-md-6">
              <label class="form-label fw-semibold text-muted">Price</label>
              <p class="form-control-plaintext">{{ product.currency|default:"TND" }} {{ product.price|floatformat:2 }}</p>
            </div>
            <div class="col-md-6">
              <label class="form-label fw-semibold text-muted">Quantity</label>
              <p class="form-control-plaintext">
                {% if product.quantity == 0 %}
                  <span class="badge bg-danger">Out of Stock</span>
                {% elif product.quantity < 10 %}
                  <span class="badge bg-warning text-dark">{{ product.quantity }}</span>
                {% else %}
                  <span class="badge bg-success">{{ product.quantity }}</span>
                {% endif %}
              </p>
            </div>
            <div class="col-12">
              <label class="form-label fw-semibold text-muted">Description</label>
              <p class="form-control-plaintext">{{ product.description|default:"No description available" }}</p>
            </div>
          </div>
        </div>
        
        <!-- Modal Footer -->
        <div class="modal-footer border-0">
          <button type="button" class="btn btn-light px-4" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary px-4" data-bs-dismiss="modal" data-bs-toggle="modal" data-bs-target="#editProductModal{{ product.id }}">
            <i class="bi bi-pencil me-1"></i> Edit Product
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Product Modal -->
  <div class="modal fade" id="editProductModal{{ product.id }}" tabindex="-1" aria-labelledby="editProductModalLabel{{ product.id }}" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content shadow-lg rounded-4">
        <form action="{% url 'edit_product' product.id %}" method="post" enctype="multipart/form-data">
          {% csrf_token %}

          <!-- Modal Header -->
          <div class="modal-header border-0 pb-0">
            <h5 class="modal-title fw-semibold" id="editProductModalLabel{{ product.id }}">
              <i class="bi bi-pencil me-2 text-secondary"></i> Edit Product
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>

          <!-- Modal Body -->
          <div class="modal-body pt-2">
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label fw-semibold">Title</label>
                <input type="text" class="form-control" name="title" value="{{ product.title }}" required>
              </div>
              <div class="col-md-6">
                <label class="form-label fw-semibold">Currency</label>
                <input type="text" class="form-control" name="currency" value="{{ product.currency|default:'TND' }}">
              </div>
              <div class="col-md-6">
                <label class="form-label fw-semibold">Price</label>
                <input type="number" step="0.01" class="form-control" name="price" value="{{ product.price }}" required>
              </div>
              <div class="col-md-6">
                <label class="form-label fw-semibold">Quantity</label>
                <input type="number" class="form-control" name="quantity" value="{{ product.quantity }}" min="0" required>
              </div>
              <div class="col-12">
                <label class="form-label fw-semibold">Description</label>
                <textarea class="form-control" name="description" rows="3">{{ product.description }}</textarea>
              </div>
            </div>
          </div>

          <!-- Modal Footer -->
          <div class="modal-footer border-0">
            <button type="button" class="btn btn-light px-4" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary px-4">
              <i class="bi bi-check-circle me-1"></i> Save Changes
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Delete Product Modal -->
  <div class="modal fade" id="deleteProductModal{{ product.id }}" tabindex="-1" aria-labelledby="deleteProductModalLabel{{ product.id }}" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content shadow-lg rounded-4">
        <form action="{% url 'delete_product' product.id %}" method="post">
          {% csrf_token %}

          <!-- Modal Header -->
          <div class="modal-header border-0 pb-0">
            <h5 class="modal-title fw-semibold text-danger" id="deleteProductModalLabel{{ product.id }}">
              <i class="bi bi-trash me-2"></i> Delete Product
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>

          <!-- Modal Body -->
          <div class="modal-body pt-2">
            <div class="alert alert-danger rounded-3" role="alert">
              <i class="bi bi-exclamation-triangle me-2"></i>
              <strong>Warning!</strong> This action cannot be undone.
            </div>
            <p class="mb-0">Are you sure you want to delete the product <strong>"{{ product.title }}"</strong>?</p>
          </div>

          <!-- Modal Footer -->
          <div class="modal-footer border-0">
            <button type="button" class="btn btn-light px-4" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-danger px-4">
              <i class="bi bi-trash me-1"></i> Delete Product
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  {% endfor %}

</main>

<script>
  // Display selected file name
  document.getElementById('excelFile')?.addEventListener('change', function(e) {
    const fileName = e.target.files[0]?.name;
    if (fileName) {
      const label = document.querySelector('label[for="excelFile"]');
      if (label) {
        label.textContent = `Selected: ${fileName}`;
      }
    }
  });

  // Prevent negative quantity in add form
  document.getElementById('addProductModal')?.querySelector('form')?.addEventListener('submit', function(e) {
    const qtyInput = this.querySelector('input[name="quantity"]');
    if (qtyInput) {
      const value = parseInt(qtyInput.value);
      if (isNaN(value) || value < 0) {
        e.preventDefault();
        qtyInput.value = 0;
        alert('Quantity cannot be negative');
      }
    }
  });
</script>
{% endblock %}