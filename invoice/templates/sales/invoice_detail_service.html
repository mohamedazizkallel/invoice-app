{% extends 'partials/base.html' %}
{% load static %}

{% block css %}
<link rel="stylesheet" href="{% static 'css/inter.css' %}">
<style>
    

    body {
        font-family: 'Inter', sans-serif !important;
        background: #f5f6f7;
    }

    .wrapper-invoice {
        display: flex;
        justify-content: center;
        padding: 40px 15px;
    }

    .invoice {
        background: #fff;
        max-width: 900px;
        width: 100%;
        box-shadow: 0px 10px 40px rgba(0,0,0,0.08);
        border-radius: 12px;
        padding: 40px;
        animation: fadeIn 0.4s ease;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .invoice-information p {
        margin: 0;
        line-height: 1.6;
        font-size: 15px;
    }

    .invoice-logo-brand img {
        width: 130px;
        margin-top: 10px;
        filter: drop-shadow(0px 1px 2px rgba(0,0,0,0.2));
    }

    .invoice-head {
        display: flex;
        justify-content: space-between;
        margin-top: 35px;
        gap: 20px;
    }

    .invoice-body { 
        margin-top: 40px; 
    }

    .table {
        width: 100%;
        border-collapse: collapse;
    }

    .table thead {
        background: #fafafa;
        border-bottom: 2px solid #eee;
    }

    .table th, .table td {
        padding: 14px 10px;
        font-size: 15px;
        border-bottom: 1px solid #eee;
    }

    .invoice-total-amount {
        margin-top: 25px;
        text-align: right;
        font-size: 22px;
        font-weight: 700;
        color: #2f2f2f;
    }

    .invoice-footer {
        margin-top: 40px;
        text-align: center;
        font-size: 15px;
        color: #888;
        border-top: 1px solid #eee;
        padding-top: 25px;
    }

    .btn-custom {
        padding: 10px 22px;
        border-radius: 8px;
        font-weight: 600;
    }

    .btn-edit {
        background: #4c6ef5;
        color: white;
        border: none;
    }

    .btn-edit:hover {
        background: #3b5bdb;
        color: white;
    }

    .btn-back {
        border: 1px solid #adb5bd;
        color: #495057;
        background: white;
    }

    .btn-back:hover {
        background: #f8f9fa;
    }

    .btn-print {
        background: #12b886;
        color: white;
        border: none;
    }

    .btn-print:hover {
        background: #0ca678;
        color: white;
    }

    .modal-content {
        animation: modalFade 0.25s ease-out;
        border: none;
    }

    @keyframes modalFade {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @media (max-width: 700px) {
        .invoice-head {
            flex-direction: column;
            text-align: left;
        }
        
        .head.client-data {
            text-align: left !important;
        }
    }

    /* ---------------- PRINT ONLY INVOICE ---------------- */
    @media print {
        body {
            background: white !important;
        }

        /* hide UI elements */
        .btn,
        .btn-custom,
        .navbar,
        .sidebar,
        .modal,
        .modal-backdrop,
        .invoice-footer,
        .mt-4,
        nav {
            display: none !important;
        }

        /* print only invoice */
        .wrapper-invoice {
            padding: 0 !important;
        }

        .invoice {
            box-shadow: none !important;
            border: none !important;
            margin: 0 !important;
            padding: 15px !important;
            max-width: 100% !important;
        }

        @page {
            size: A4;
            margin: 10mm;
        }

        /* Optimize spacing for single page */
        .invoice-information {
            margin-bottom: 8px !important;
        }

        .invoice-information p {
            font-size: 11px !important;
            line-height: 1.3 !important;
            margin: 2px 0 !important;
        }

        .invoice-header-wrapper {
            margin-bottom: 15px !important;
        }

        .invoice-logo-brand {
            position: absolute !important;
            top: 0 !important;
            right: 0 !important;
            margin: 0 !important;
        }

        .invoice-logo-brand img {
            width: 90px !important;
            margin: 0 !important;
        }

        .invoice-head {
            margin-top: 15px !important;
            gap: 15px !important;
        }

        .invoice-head p {
            font-size: 11px !important;
            line-height: 1.3 !important;
            margin: 2px 0 !important;
        }

        .invoice-body {
            margin-top: 15px !important;
        }

        .table th, .table td {
            padding: 6px 5px !important;
            font-size: 10px !important;
        }

        .table thead {
            background: #f5f5f5 !important;
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }

        .invoice-body > div {
            margin-top: 10px !important;
        }

        .invoice-body table {
            font-size: 10px !important;
        }

        .invoice-body table td {
            padding: 4px !important;
        }

        .invoice-body table tr:last-child td {
            font-size: 12px !important;
            padding: 6px !important;
        }

        .invoice-body > div > div {
            padding: 8px !important;
            font-size: 10px !important;
        }

        .invoice-body > div > div p {
            font-size: 10px !important;
            margin: 3px 0 !important;
        }

        /* Ensure everything fits on one page */
        * {
            page-break-inside: avoid !important;
        }

        .invoice {
            page-break-after: avoid !important;
        }
    }

    .modal-body {
        overflow-y: auto !important;
    }

    .modal-dialog-scrollable .modal-body {
        max-height: 70vh;
    }

    /* New: Position logo in top right for screen view */
    .invoice-header-wrapper {
        position: relative;
        min-height: 120px;
    }

    .invoice-logo-brand {
        position: absolute;
        top: 0;
        right: 0;
        margin: 0;
    }
</style>
{% endblock %}

{% block main %}
<main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
    <!-- ========= INVOICE CONTENT ========= -->
    <section class="wrapper-invoice">
        <div class="invoice" id="invoiceArea">

            <div class="invoice-header-wrapper">
                <div class="invoice-information">
                    <p><b>Facture n°</b> : {{ invoice.uniqueId }}</p>
                    <p><b>Date de création</b> : {{ invoice.date_created|date:"M d, Y" }}</p>
                    <p><b>Statut</b> : <span class="badge {% if invoice.status == 'PAID' %}bg-success{% elif invoice.status == 'OVERDUE' %}bg-danger{% elif invoice.status == 'CURRENT' %}bg-info{% else %}bg-secondary{% endif %}">{{ invoice.status }}</span></p>
                </div>

                <div class="invoice-logo-brand">
                    {% if p_settings and p_settings.clientLogo %}
                        <img src="{{ p_settings.clientLogo.url }}" alt="Company Logo">
                    {% else %}
                        <img src="{% static 'assets/img/logo.png' %}" alt="Company Logo">
                    {% endif %}
                </div>
            </div>

            <div class="invoice-head">
                <div class="head client-info">
                    <p><strong>De:</strong></p>
                    <p><strong>{{ p_settings.clientname|default:"Your Company Name" }}</strong></p>
                    <p>{{ p_settings.adress|default:"Your Address" }}</p>
                    {% if p_settings.mf %}<p>MF: {{ p_settings.mf }}</p>{% endif %}
                </div>

                <div class="head client-data" style="text-align:right;">
                    <p><strong>Facture à:</strong></p>
                    <p><strong>{{ invoice.client.clientname }}</strong></p>
                    <p>{{ invoice.client.adress }}</p>
                    {% if invoice.client.emailAddress %}<p>{{ invoice.client.emailAddress }}</p>{% endif %}
                    {% if invoice.client.mf %}<p>MF: {{ invoice.client.mf }}</p>{% endif %}
                </div>
            </div>

            <div class="invoice-body">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Description de l'article/Service</th>
                            <th style="text-align:center;"></th>
                            <th style="text-align:right;">Prix unitaire</th>
                            <th style="text-align:right;">Montant</th>
                        </tr>
                    </thead>
                    <tbody>
                    {% if services_with_totals %}
                        {% for item in services_with_totals %}
                        <tr>
                            <td>
                                {{ item.service.title }}
                            </td>
                            <td style="text-align:center;"></td>
                            <td style="text-align:right;">{{ item.service.currency|default:"TND" }} {{ item.unit_price|floatformat:3 }}</td>
                            <td style="text-align:right;">{{ item.service.currency|default:"TND" }} {{ item.line_total|floatformat:3 }}</td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="4" style="text-align:center; color: #888;">Aucun service attribué à cette facture</td>
                        </tr>
                    {% endif %}
                    </tbody>
                </table>

                {% if services_with_totals %}
                <div style="margin-top: 25px; text-align: right;">
                    <table style="width: 300px; margin-left: auto; border-collapse: collapse;">
                        <tr>
                            <td style="padding: 8px; border-top: 1px solid #eee;"><strong>Sous-total HT:</strong></td>
                            <td style="padding: 8px; text-align: right; border-top: 1px solid #eee;">{{ invoiceCurrency }} {{ subtotal|floatformat:3 }}</td>
                        </tr>
                        {% if invoice.discount > 0 %}
                        <tr>
                            <td style="padding: 8px;"><strong>Réduction ({{ invoice.discount }}%):</strong></td>
                            <td style="padding: 8px; text-align: right; color: #dc3545;">-{{ invoiceCurrency }} {{ discount_amount|floatformat:3 }}</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px;"><strong>Sous-total après remise:</strong></td>
                            <td style="padding: 8px; text-align: right;">{{ invoiceCurrency }} {{ subtotal_after_discount|floatformat:3 }}</td>
                        </tr>
                        {% endif %}
                        <tr>
                            <td style="padding: 8px;"><strong>TVA ({{ invoice.tva }}%):</strong></td>
                            <td style="padding: 8px; text-align: right;">{{ invoiceCurrency }} {{ tva_amount|floatformat:3 }}</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px;"><strong>Timbre Fiscal (D):</strong></td>
                            <td style="padding: 8px; text-align: right;">{{ invoiceCurrency }} {{ invoice.timbre_fiscal|floatformat:3 }}</td>
                        </tr>
                        <tr style="border-top: 2px solid #2f2f2f;">
                            <td style="padding: 12px;"><strong style="font-size: 18px;">Total TTC:</strong></td>
                            <td style="padding: 12px; text-align: right; font-size: 18px; font-weight: 700;">{{ invoiceCurrency }} {{ total|floatformat:3 }}</td>
                        </tr>
                    </table>
                </div>
                
                {% endif %}
            </div>

            {% if invoice.notes %}
            <div style="margin-top:25px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                <strong>Remarques :</strong>
                <p style="margin: 5px 0 0 0;">{{ invoice.notes }}</p>
            </div>
            {% endif %}
            <div style="margin-top:25px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                <strong>Total en lettre:</strong>
                <p style="margin: 5px 0 0 0;">cette facture correspondait à un montant total {{ total_in_words }}</p>
            </div>
            <div class="invoice-footer">
                <p>Merci de votre confiance !</p>
            </div>

            <!-- Buttons -->
            <div class="mt-4 d-flex gap-2 justify-content-between flex-wrap">
                <a href="{% url 'invoices_list' %}" class="btn btn-back btn-custom">
                    <i class="bi bi-arrow-left me-1"></i> Retour aux factures
                </a>

                <div class="d-flex gap-2">
                    <button class="btn btn-print btn-custom" onclick="window.print()">
                        <i class="bi bi-printer me-1"></i> Imprimer la facture
                    </button>

                    <button class="btn btn-edit btn-custom" data-bs-toggle="modal" data-bs-target="#editInvoiceModal{{ invoice.id }}">
                        <i class="bi bi-pencil me-1"></i> Modifier la facture
                    </button>
                </div>
            </div>

        </div>
    </section>

    <!-- ========= ENHANCED EDIT MODAL ========= -->
    <div class="modal fade" id="editInvoiceModal{{ invoice.id }}" tabindex="-1" aria-labelledby="editInvoiceModalLabel{{ invoice.id }}" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content shadow-lg rounded-4">
                <form action="{% url 'invoice_edit' invoice.id %}" method="post" id="editInvoiceForm{{ invoice.id }}">
                    {% csrf_token %}
                    <input type="hidden" name="services_data" id="edit_services_data_{{ invoice.id }}">

                    <!-- Modal Header -->
                    <div class="modal-header border-0 pb-0">
                        <h5 class="modal-title fw-semibold" id="editInvoiceModalLabel{{ invoice.id }}">
                            <i class="bi bi-pencil me-2 text-secondary"></i> Modifier la facture
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>

                    <!-- Modal Body -->
                    <div class="modal-body pt-2">
                        {% if form.errors %}
                        <div class="alert alert-danger rounded-3" role="alert">
                            <strong><i class="bi bi-exclamation-triangle me-2"></i> Veuillez corriger les erreurs suivantes :</strong>
                            <ul class="mt-2 mb-0">
                                {% for field, errors in form.errors.items %}
                                    {% for error in errors %}
                                    <li>{{ field }}: {{ error }}</li>
                                    {% endfor %}
                                {% endfor %}
                            </ul>
                        </div>
                        {% endif %}

                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">Titre de la facture</label>
                                <input type="text" class="form-control" name="title" value="{{ invoice.title }}" required>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label fw-semibold">Client</label>
                                <select class="form-select" name="client" required>
                                    {% for client in clients %}
                                    <option value="{{ client.id }}" {% if invoice.client.id == client.id %}selected{% endif %}>
                                        {{ client.clientname }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>

                            <div class="col-md-3">
                                <label class="form-label fw-semibold">Status</label>
                                <select class="form-select" name="status">
                                    <option value="CURRENT" {% if invoice.status == "CURRENT" %}selected{% endif %}>Actuel</option>
                                    <option value="OVERDUE" {% if invoice.status == "OVERDUE" %}selected{% endif %}>En retard</option>
                                    <option value="PAID" {% if invoice.status == "PAID" %}selected{% endif %}>Rémunéré</option>
                                </select>
                            </div>

                            <div class="col-md-3">
                                <label class="form-label fw-semibold">TVA (%)</label>
                                <input type="number" step="0.01" class="form-control" name="tva" value="{{ invoice.tva|default:19.00 }}">
                            </div>

                            <div class="col-md-3">
                                <label class="form-label fw-semibold">Timbre Fiscal (D)</label>
                                <input type="number" step="0.001" class="form-control" name="timbre_fiscal" value="{{ invoice.timbre_fiscal|default:1.000 }}">
                            </div>

                            <div class="col-md-3">
                                <label class="form-label fw-semibold">Réduction (%)</label>
                                <input type="number" step="0.01" class="form-control" name="discount" value="{{ invoice.discount|default:0.00 }}">
                            </div>

                            <div class="col-12">
                                <label class="form-label fw-semibold">Remarques</label>
                                <textarea class="form-control" name="notes" rows="2">{{ invoice.notes }}</textarea>
                            </div>

                            <!-- services Section -->
                            <div class="col-12">
                                <hr class="my-3">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h6 class="mb-0 fw-semibold">
                                        <i class="bi bi-briefcase me-2"></i> Ajouter/Modifier des services
                                    </h6>
                                    <button type="button" class="btn btn-sm btn-outline-primary" id="addEditServiceRow_{{ invoice.id }}">
                                        <i class="bi bi-plus-circle me-1"></i> Ajouter un service
                                    </button>
                                </div>

                                <div id="editServicesContainer_{{ invoice.id }}">
                                    <!-- Preloaded Services Rows -->
                                    {% for service in invoice.service.all %}
                                    <div class="card mb-2 service-row" data-row="{{ forloop.counter0 }}">
                                        <div class="card-body p-3">
                                            <div class="row g-2 align-items-end">
                                                <div class="col-md-8">
                                                    <label class="form-label small mb-1">Service</label>
                                                    <select class="form-select form-select-sm service-select" data-row="{{ forloop.counter0 }}">
                                                        {% for p in all_services %}
                                                        <option value="{{ p.id }}" 
                                                                data-price="{{ p.price }}" 
                                                                data-currency="{{ p.currency|default:'TND' }}"
                                                                {% if p.id == service.id %}selected{% endif %}>
                                                            {{ p.title }} - {{ p.currency|default:"TND" }} {{ p.price }}
                                                        </option>
                                                        {% endfor %}
                                                    </select>
                                                </div>
                                                <div class="col-md-3">
                                                    <label class="form-label small mb-1">Total</label>
                                                    <input type="text" class="form-control form-control-sm line-total" data-row="{{ forloop.counter0 }}" readonly>
                                                </div>
                                                <div class="col-md-1">
                                                    <button type="button" class="btn btn-sm btn-outline-danger w-100 remove-service" data-row="{{ forloop.counter0 }}">
                                                        <i class="bi bi-trash"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>

                                <div class="alert alert-info mt-3" role="alert">
                                    <small>
                                        <i class="bi bi-info-circle me-1"></i>
                                        Cliquez sur « Ajouter un service » pour ajouter des services à cette facture. Les services sont facturés à un tarif forfaitaire.
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Modal Footer -->
                    <div class="modal-footer border-0">
                        <button type="button" class="btn btn-light px-4" data-bs-dismiss="modal">Annuler</button>
                        <button type="submit" class="btn btn-primary px-4">
                            <i class="bi bi-check-circle me-1"></i> Enregistrer les modifications
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</main>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const invoiceId = '{{ invoice.id }}';
    const container = document.getElementById(`editServicesContainer_${invoiceId}`);
    const addButton = document.getElementById(`addEditServiceRow_${invoiceId}`);
    const form = document.getElementById(`editInvoiceForm${invoiceId}`);
    const servicesDataInput = document.getElementById(`edit_services_data_${invoiceId}`);
    
    let rowCounter = {{ invoice.service.all|length }};

    // Services data from backend
    const availableServices = [
        {% for p in all_services %}
        {
            id: '{{ p.id }}',
            title: '{{ p.title|escapejs }}',
            price: parseFloat('{{ p.price }}'),
            currency: '{{ p.currency|default:"TND" }}'
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];

    // Calculate line total (services don't use quantity)
    function calculateLineTotal(row) {
        const select = container.querySelector(`.service-select[data-row="${row}"]`);
        const totalInput = container.querySelector(`.line-total[data-row="${row}"]`);
        
        if (select && totalInput) {
            const selectedOption = select.options[select.selectedIndex];
            const price = parseFloat(selectedOption.dataset.price) || 0;
            const currency = selectedOption.dataset.currency || 'TND';
            
            totalInput.value = `${currency} ${price.toFixed(3)}`;
        }
    }

    // Add new service row
    addButton.addEventListener('click', function() {
        const newRow = document.createElement('div');
        newRow.className = 'card mb-2 service-row';
        newRow.dataset.row = rowCounter;
        
        newRow.innerHTML = `
            <div class="card-body p-3">
                <div class="row g-2 align-items-end">
                    <div class="col-md-8">
                        <label class="form-label small mb-1">Service</label>
                        <select name="service_id[]" class="form-select form-select-sm service-select" data-row="${rowCounter}">
                            <option value="">Select a service...</option>
                            {% for p in all_services %}
                            <option value="{{ p.id }}" 
                                    data-price="{{ p.price }}" 
                                    data-currency="{{ p.currency|default:'TND' }}">
                                {{ p.title }} - {{ p.currency|default:"TND" }} {{ p.price }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label small mb-1">Total</label>
                        <input type="text" class="form-control form-control-sm line-total" data-row="${rowCounter}" readonly>
                    </div>
                    <div class="col-md-1">
                        <button type="button" class="btn btn-sm btn-outline-danger w-100 remove-service" data-row="${rowCounter}">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        container.appendChild(newRow);
        
        // Attach event listeners to new row
        const select = newRow.querySelector('.service-select');
        const removeBtn = newRow.querySelector('.remove-service');
        
        select.addEventListener('change', () => calculateLineTotal(rowCounter));
        removeBtn.addEventListener('click', () => newRow.remove());
        
        rowCounter++;
    });

    // Attach listeners to existing rows
    container.querySelectorAll('.service-row').forEach(row => {
        const rowNum = row.dataset.row;
        const select = row.querySelector('.service-select');
        const removeBtn = row.querySelector('.remove-service');
        
        // Add name attributes for form submission
        if (select) {
            select.name = 'service_id[]';
            select.addEventListener('change', () => calculateLineTotal(rowNum));
            calculateLineTotal(rowNum); // Initial calculation
        }
        if (removeBtn) {
            removeBtn.addEventListener('click', () => row.remove());
        }
    });

    // Form submission - collect services data (optional if using name arrays)
    form.addEventListener('submit', function(e) {
        const rows = container.querySelectorAll('.service-row');
        
        if (rows.length === 0) {
            e.preventDefault();
            alert('Please add at least one service to the invoice.');
            return false;
        }
        
        // Check if any service is selected
        let hasValidService = false;
        rows.forEach(row => {
            const select = row.querySelector('.service-select');
            if (select && select.value) {
                hasValidService = true;
            }
        });
        
        if (!hasValidService) {
            e.preventDefault();
            alert('Please select at least one service.');
            return false;
        }
    });
});
</script>
{% endblock %}